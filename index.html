
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ethniq Attire | Premium & Luxury</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <script>
    const { useState, useEffect, useRef, useMemo } = React;
    
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { serif: ['"Playfair Display"', 'serif'], sans: ['"Lato"', 'sans-serif'] },
          colors: { gold: { 500: '#bfa15f', 600: '#9e824c', 100: '#f9f3e5', 800: '#8c6b32' }, navy: { 800: '#2d3748', 900: '#1a202c', 950: '#0f172a' } },
          animation: { 'slow-zoom': 'slowZoom 20s infinite alternate', 'fade-in': 'fadeIn 0.3s ease-in-out', 'slide-up': 'slideUp 0.8s ease-out', 'pop-in': 'popIn 0.3s ease-out', 'marquee': 'marquee 25s linear infinite', 'float': 'float 3s ease-in-out infinite' },
          keyframes: {
            slowZoom: { '0%': { transform: 'scale(1)' }, '100%': { transform: 'scale(1.1)' } },
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
            popIn: { '0%': { opacity: '0', transform: 'scale(0.9)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
            marquee: { '0%': { transform: 'translateX(0)' }, '100%': { transform: 'translateX(-100%)' } },
            float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }
          }
        }
      }
    }
  </script>

  <style>
    body { font-family: 'Lato', sans-serif; background-color: #ffffff; }
    h1, h2, h3, h4 { font-family: 'Playfair Display', serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    @media (max-width: 768px) { body { padding-bottom: 80px; } }
    .text-luxury-gold { background: radial-gradient(ellipse at center, #ffd700 0%, #b8860b 60%, #8b6508 100%); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
    .vignette-overlay { background: radial-gradient(circle, rgba(0,0,0,0) 20%, rgba(15, 23, 42, 0.8) 85%, rgba(15, 23, 42, 1) 100%); }
    img { display: block; }
  </style>
</head>
<body class="text-gray-800 antialiased">
<div id="root"></div>

<script type="text/babel">
  // --- CONFIGURATION ---
  const MERCHANT_ID = "CFw8pFa2XEdJU8VdcTcVBzDTyBG2";
  const APP_ID = "ethniq-attire-bmc-e9289";
  const PRIVE_PRICE_THRESHOLD = 2500;
  const INITIAL_PRODUCT_LIMIT = 6;
  const GEMINI_API_KEY = "AIzaSyBS3Qg0-Sh_IvjlxogfYr_WjB1sI1sE9Vw";
  const ZARA_ICON = "https://cdn-icons-png.flaticon.com/512/4140/4140047.png";

  // --- PAYMENT CONFIG ---
  const UPI_ID = "stk-7890000144@okbizaxis"; // Your UPI ID
  const MERCHANT_NAME = "Ethniq Attire";
  const QR_CODE_URL = "https://firebasestorage.googleapis.com/v0/b/ethniq-attire-bmc-e9289.firebasestorage.app/o/photo_2025-12-02_18-47-35.jpg?alt=media&token=95d0ff4d-7701-4121-b0fd-c3c6597ef9e5";

  // --- BANK TRANSFER DETAILS (REPLACE WITH YOURS) ---
  const BANK_ACCOUNT_NUMBER = "017801000022803"; // Your Account Number
  const BANK_IFSC_CODE = "IOBA0000178"; // Your Bank's IFSC Code
  const BANK_BENEFICIARY_NAME = "TAUSIF JAMAL ERAKI"; // The name on the bank account

  const REGULAR_LOGO_URL = "https://image2url.com/images/1763633078260-9d4fee1d-e7f4-4bfb-8e5f-d89378ff8348.jpg";
  const PRIVE_LOGO_URL = "https://image2url.com/images/1764242722924-0b585f5b-ce18-4a87-b85f-981e2986d061.png";

  const REGULAR_SLIDES = [ "https://image2url.com/images/1763640433851-82afe207-f8ef-4edb-860a-17b302c6cf69.jpg", "https://image2url.com/images/1764246771418-f45eb15e-1a17-482f-9ea1-1926e660abb5.webp", "https://image2url.com/images/1764247032315-911169ac-246d-4a71-916d-bb6d8e497e05.jpg" ];
  const PRIVE_SLIDES = [  "https://image2url.com/images/1763640433851-82afe207-f8ef-4edb-860a-17b302c6cf69.jpg", "https://image2url.com/images/1764249541011-fd0efeb7-99cf-4da5-8904-1352beb8b382.jpg" ];

  const PHONE_NUMBER = "+91 6290328892";
  const WHATSAPP_LINK = "https://wa.me/916290328892";
  const INSTA_LINK_REGULAR = "https://www.instagram.com/ethniqattire?igsh=ajB4ZXZicjgybGo1";
  const INSTA_LINK_PRIVE = "https://www.instagram.com/ethniqattire_prive";
  const FB_LINK = "https://www.facebook.com/share/17gjRmjyqG/";
  const EMAIL_ID = "ethniqattire.customercare@outlook.com";
  const ADDRESS = "28 No, Garden Reach Road Kolkata 700024";

  const firebaseConfig = { apiKey: "AIzaSyDCckDxI6OFsD3aaKZF3TVQAwpPpLYbxkQ", authDomain: "ethniq-attire-bmc-e9289.firebaseapp.com", projectId: "ethniq-attire-bmc-e9289", storageBucket: "ethniq-attire-bmc-e9289.firebasestorage.app", messagingSenderId: "239627340624", appId: "1:239627340624:web:4338500530b656e0a2ba55", measurementId: "G-WCQ5CSBM2R" };

  // --- INTERNATIONALIZATION DATA ---
  const countries = [
      { name: "India", dial_code: "+91", code: "IN" },
      { name: "United States", dial_code: "+1", code: "US" },
      { name: "United Kingdom", dial_code: "+44", code: "GB" },
      { name: "Australia", dial_code: "+61", code: "AU" },
      { name: "Canada", dial_code: "+1", code: "CA" },
      { name: "Germany", dial_code: "+49", code: "DE" },
      { name: "France", dial_code: "+33", code: "FR" },
      { name: "United Arab Emirates", dial_code: "+971", code: "AE" },
      // Add more countries as needed
  ];

  if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
  const db = firebase.firestore();
  const auth = firebase.auth();
  const storage = firebase.storage();

  const formatCurrency = (amount) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount);

  // Utility function to get the user's Firestore document reference
  const parsePhoneNumber = (fullNumber) => {
      if (!fullNumber) return { countryCode: '+91', number: '' };
      const fullNumStr = String(fullNumber).replace(/\s/g, '');

      // Find the longest matching country code
      const country = countries.sort((a, b) => b.dial_code.length - a.dial_code.length).find(c => fullNumStr.startsWith(c.dial_code));

      if (country) return { countryCode: country.dial_code, number: fullNumStr.substring(country.dial_code.length) };

      return { countryCode: '+91', number: fullNumStr.replace(/^\+91/, '') }; // Default to India
  };
  const userDocRef = (uid) => db.collection('artifacts').doc(APP_ID).collection('users').doc(MERCHANT_ID).collection('customers').doc(uid);

  // --- ICONS ---
  const IconBag = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" className={className || "h-6 w-6"} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>;
  const IconHome = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" className={className || "h-6 w-6"} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>;
  const IconHeart = ({ filled, className }) => <svg xmlns="http://www.w3.org/2000/svg" className={className || `h-6 w-6 transition-colors ${filled ? 'fill-red-500 text-red-500' : 'fill-none stroke-current'}`} viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>;
  const IconSearch = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" className={className || "h-6 w-6"} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>;
  const IconClose = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M6 18L18 6M6 6l12 12" /></svg>;
  const IconStarOutline = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" className={className || "h-6 w-6"} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>;
  const IconCategory = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" className={className || "h-6 w-6"} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>;
  const IconUpload = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>;
  const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
const IconWarning = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>;
  // UPDATED ICON: More elegant user/profile icon
  const IconUser = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" className={className || "h-6 w-6"} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.7}><path strokeLinecap="round" strokeLinejoin="round" d="M19 21v-2a4 4 0 00-4-4H9a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
  const IconBox = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" className={className || "h-6 w-6"} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>;
  const IconLogOut = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" className={className || "h-6 w-6"} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-10a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>;
  const IconSave = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" className={className || "h-6 w-6"} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8 7V3h8v4m-3 7v4m-4-2h8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>;
  const IconLocation = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" className={className || "h-5 w-5"} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>;

  const IconInsta = () => <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zM12 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>;
  const IconFB = () => <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.791-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>;
  const IconWhatsapp = () => <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>;
  const IconPhone = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>;
  const IconMail = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>;
  const IconMap = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>;
  const IconClock = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>;
  const IconStar = ({ filled, onClick }) => ( <svg onClick={onClick} className={`w-4 h-4 cursor-pointer ${filled ? 'text-yellow-400 fill-current' : 'text-gray-300'}`} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"> <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /> </svg> );
  const IconShare = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" className={className || "h-6 w-6"} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>;
  const IconLantern = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" className={className || "w-6 h-6"} viewBox="0 0 512 512" fill="currentColor"><path d="M256 0C238.3 0 224 14.3 224 32V48H208C181.5 48 160 69.5 160 96V128H144C117.5 128 96 149.5 96 176V368C96 394.5 117.5 416 144 416H176V448C176 465.7 190.3 480 208 480H304C321.7 480 336 465.7 336 448V416H368C394.5 416 416 394.5 416 368V176C416 149.5 394.5 128 368 128H352V96C352 69.5 330.5 48 304 48H288V32C288 14.3 273.7 0 256 0zM208 96H304V128H208V96zM144 176H368V368H144V176z"/></svg>;

  // --- UTILITY COMPONENTS ---
  const NotificationToast = ({ message, isVisible, isPrive }) => {
      if (!isVisible) return null;
      return ( <div className={`fixed top-24 left-1/2 transform -translate-x-1/2 z-[100] px-6 py-3 rounded shadow-xl flex items-center gap-3 animate-fade-in transition-all ${isPrive ? 'bg-gold-600 text-black' : 'bg-navy-900 text-white'}`}> <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path></svg> <span className="text-sm font-bold tracking-wide uppercase">{message}</span> </div> );
  };

  const SuccessModal = ({ isOpen, onClose, isPrive, title = "Submitted!", message }) => {
      if (!isOpen) return null;
      return ( <div className="fixed inset-0 z-[80] flex items-center justify-center p-4"> <div className="fixed inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div> <div className={`relative w-full max-w-sm p-6 rounded-xl shadow-2xl text-center transform transition-all scale-100 animate-pop-in ${isPrive ? 'bg-navy-900 text-white border border-gold-600/30' : 'bg-white text-gray-900'}`}> <div className="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4"> <svg className="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path></svg> </div> <h3 className="text-xl leading-6 font-serif font-bold mb-2">{title}</h3> <p className={`text-sm mb-6 ${isPrive ? 'text-gray-300' : 'text-gray-500'}`}>{message}</p> <button onClick={onClose} className={`w-full py-3 px-4 rounded font-bold uppercase tracking-wider text-xs transition shadow-lg ${isPrive ? 'bg-gold-600 text-white hover:bg-gold-700' : 'bg-navy-900 text-white hover:bg-navy-800'}`}>Continue</button> </div> </div> );
  };

  const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message, confirmText = "Confirm", cancelText = "Cancel", isPrive }) => {
      if (!isOpen) return null;
      return ( <div className="fixed inset-0 z-[90] flex items-center justify-center p-4"> <div className="fixed inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div> <div className={`relative w-full max-w-sm p-6 rounded-xl shadow-2xl text-center transform transition-all scale-100 animate-pop-in ${isPrive ? 'bg-navy-900 text-white border border-gold-600/30' : 'bg-white text-gray-900'}`}> <div className="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-yellow-100 mb-4"> <IconWarning /> </div> <h3 className="text-xl leading-6 font-serif font-bold mb-2">{title}</h3> <p className={`text-sm mb-6 ${isPrive ? 'text-gray-300' : 'text-gray-500'}`}>{message}</p> <div className="flex gap-4"> <button onClick={onClose} className={`w-full py-3 px-4 rounded font-bold uppercase tracking-wider text-xs transition shadow-lg ${isPrive ? 'bg-navy-800 text-white hover:bg-navy-700' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>{cancelText}</button> <button onClick={onConfirm} className={`w-full py-3 px-4 rounded font-bold uppercase tracking-wider text-xs transition shadow-lg ${isPrive ? 'bg-gold-600 text-black hover:bg-gold-700' : 'bg-red-600 text-white hover:bg-red-700'}`}>{confirmText}</button> </div> </div> </div> );
  };

  const LegalModal = ({ isOpen, onClose, title, content, isPrive }) => {
      if (!isOpen) return null;
      return (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
              <div className="fixed inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose}></div>
              <div className={`relative w-full max-w-lg p-8 rounded-xl shadow-2xl max-h-[80vh] overflow-y-auto animate-pop-in ${isPrive ? 'bg-navy-900 text-white border border-gold-600/30' : 'bg-white text-gray-900'}`}>
                  <button onClick={onClose} className={`absolute top-4 right-4 p-2 rounded-full ${isPrive ? 'hover:bg-navy-800' : 'hover:bg-gray-100'}`}><IconClose /></button>
                  <h3 className={`text-2xl font-serif font-bold mb-6 border-b pb-4 ${isPrive ? 'text-gold-500 border-navy-800' : 'text-gray-900 border-gray-100'}`}>{title}</h3>
                  <div className={`prose text-sm leading-relaxed whitespace-pre-line ${isPrive ? 'text-gray-300' : 'text-gray-600'}`}>
                      {content}
                  </div>
              </div>
          </div>
      );
  };

  const SearchModal = ({ isOpen, onClose, searchQuery, setSearchQuery, results, onOpenProduct, isPrive, onSeeAll }) => {
      const inputRef = useRef(null);
      useEffect(() => { if(isOpen && inputRef.current) inputRef.current.focus(); }, [isOpen]);
      if (!isOpen) return null;
      return (
          <div className="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex flex-col">
              <div className={`p-4 shadow-lg rounded-b-xl ${isPrive ? 'bg-navy-900 text-white border-b border-gold-600/30' : 'bg-white text-gray-900'}`}>
                  <div className="flex items-center gap-3 mb-4">
                      <div className={`flex-1 flex items-center rounded-full px-4 py-2 ${isPrive ? 'bg-navy-800 border border-gold-500/30' : 'bg-gray-100'}`}>
                          <IconSearch className={`w-5 h-5 ${isPrive ? 'text-gold-500' : 'text-gray-500'}`} />
                          <input
                              ref={inputRef}
                              type="text"
                              placeholder="Search products..."
                              className="bg-transparent border-none outline-none w-full ml-2 text-sm"
                              value={searchQuery}
                              onChange={(e) => setSearchQuery(e.target.value)}
                          />
                          {searchQuery && <button onClick={() => setSearchQuery('')}><IconClose className="w-4 h-4 opacity-50" /></button>}
                      </div>
                      <button onClick={onClose} className="text-sm font-bold">CANCEL</button>
                  </div>
                  {searchQuery.length > 0 && (
                      <div className="max-h-[60vh] overflow-y-auto">
                          {results.length > 0 ? (
                              <ul>
                                  {results.map(product => (
                                      <li key={product.id} onClick={() => { onOpenProduct(product); onClose(); }} className={`flex items-center gap-3 p-3 border-b ${isPrive ? 'border-navy-800' : 'border-gray-100'}`}>
                                          <img src={product.images && product.images[0]} className="w-12 h-12 object-cover rounded" />
                                          <div>
                                              <p className="text-sm font-bold">{product.title}</p>
                                              <p className="text-xs opacity-70">{formatCurrency(product.finalPrice)}</p>
                                          </div>
                                      </li>
                                  ))}
                                  <li onClick={() => { onSeeAll(); onClose(); }} className="p-3 text-center text-xs font-bold uppercase tracking-widest cursor-pointer mt-2 rounded bg-opacity-10 bg-gray-500"> View All Results </li>
                              </ul>
                          ) : (
                              <div className="p-4 text-center opacity-60 text-sm">No products found.</div>
                          )}
                      </div>
                  )}
              </div>
              <div className="flex-grow" onClick={onClose}></div>
          </div>
      );
  };

  const CategoriesModal = ({ isOpen, onClose, categories, onSelectCategory, isPrive }) => {
      if (!isOpen) return null;
      return ( <div className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center"> <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div> <div className={`relative w-full sm:max-w-sm p-6 rounded-t-xl sm:rounded-xl shadow-2xl max-h-[80vh] overflow-y-auto animate-slide-up ${isPrive ? 'bg-navy-900 text-white border-t border-gold-600/30' : 'bg-white text-gray-900'}`}> <div className="flex justify-between items-center mb-6"> <h3 className="text-lg font-serif font-bold">Shop by Category</h3> <button onClick={onClose}><IconClose /></button> </div> <div className="space-y-2"> {categories.map(cat => ( <button key={cat} onClick={() => { onSelectCategory(cat); onClose(); }} className={`w-full text-left py-4 px-4 rounded-lg text-sm font-bold uppercase tracking-widest transition-colors ${isPrive ? 'bg-navy-800 hover:bg-navy-700 border border-navy-700' : 'bg-gray-50 hover:bg-gray-100 border border-gray-100'}`}> {cat} </button> ))} </div> </div> </div> );
  };

  // --- BRANDED AI ASSISTANT WITH MEMORY & STABLE CONNECTION ---
  const AIChatAssistant = ({ user, isPrive, products = [], userData = {}, onOpenProduct }) => {
      const [isOpen, setIsOpen] = useState(false);
      const [input, setInput] = useState('');
      // This array stores the conversation history for memory
      const [messages, setMessages] = useState([
          { role: 'model', text: "Ramadan Mubarak! ðŸŒ™âœ¨ I'm Zara, your personal stylist at Ethniq Attire. Looking for the perfect Eid outfit today? ðŸ’–" }
      ]);
      const [loading, setLoading] = useState(false);
      const [activeModel, setActiveModel] = useState('models/gemini-1.5-flash');
      const [recentOrders, setRecentOrders] = useState([]);
      const chatEndRef = useRef(null);

      // AUTO-DETECT: Find the best available model for this API Key
      useEffect(() => {
          fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_API_KEY.trim()}`)
              .then(res => res.json())
              .then(data => {
                  console.log("âœ… AVAILABLE MODELS:", data);
                  if (data.models) {
                      // Try to find gemini-1.5-flash, then gemini-pro, then any content generation model
                      const bestModel = data.models.find(m => m.name.includes('gemini-1.5-flash')) ||
                                        data.models.find(m => m.name.includes('gemini-pro')) ||
                                        data.models.find(m => m.supportedGenerationMethods && m.supportedGenerationMethods.includes('generateContent'));

                      if (bestModel) setActiveModel(bestModel.name);
                  }
              })
              .catch(err => console.error("âŒ API KEY ERROR:", err));
      }, []);

      // FETCH RECENT ORDERS FOR CONTEXT
      useEffect(() => {
          if (user) {
              db.collection('artifacts').doc(APP_ID).collection('users').doc(MERCHANT_ID).collection('orders')
                  .where('userId', '==', user.uid).get()
                  .then(snapshot => {
                      const orders = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                      orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                      setRecentOrders(orders.slice(0, 5));
                  }).catch(err => console.error("Order fetch error", err));
          }
      }, [user]);

      useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

      // UPGRADE: Function to reset the conversation
      const clearChat = () => {
          setMessages([{ role: 'model', text: "Ramadan Mubarak! ðŸŒ™âœ¨ I'm Zara, your personal stylist at Ethniq Attire. Looking for the perfect Eid outfit today? ðŸ’–" }]);
      };

      const quickPrompts = ["Show me new arrivals âœ¨", "Track my order ðŸ“¦"];

      const sendMessage = async (e, overrideText = null) => {
          if (e) e.preventDefault();
          const userText = overrideText || input.trim();
          if (!userText || loading) return;

          const updatedMessages = [...messages, { role: 'user', text: userText }];

          setMessages(updatedMessages);
          setInput('');
          setLoading(true);

          // UPGRADE: Feed Inventory to AI & Set Strict Rules
          const productContext = products.filter(p => {
              const stockVal = p.stock !== undefined ? p.stock : (p.quantity !== undefined ? p.quantity : 0);
              return Number(stockVal) > 0;
          // UPGRADE: Increased limit from 50 to 300 products so AI knows more inventory
          }).slice(0, 300).map(p => {
              const isUnstitched = p.title.toLowerCase().includes('unstitched') || (p.category && p.category.toLowerCase().includes('unstitched'));
              const type = isUnstitched ? "Unstitched" : "Stitched/Ready-to-Wear";
              return `- ${p.title} (${p.category} | ${type}): ${formatCurrency(p.finalPrice)}`;
          }).join('\n');
          const userName = userData.name ? userData.name.split(' ')[0] : "Guest";

          // UPGRADE: Random Discount Code Logic (One per person)
          const discountCodes = ["LOVE15", "LOVEYOU15", "MUCHLOVE15", "CUTE15", "CARING15", "BEAUTIFUL15"];
          // FIX: Use existing code if available to prevent generating new ones on new devices
          const existingCode = (userData && userData.zaraReward && userData.zaraReward.code) || localStorage.getItem(`zara_code_given_${user.uid}`);
          const randomCode = existingCode || discountCodes[Math.floor(Math.random() * discountCodes.length)];
          const hasReceivedCode = (userData && userData.zaraReward) || localStorage.getItem(`zara_code_given_${user.uid}`);

          let discountRules = "";
          if (hasReceivedCode) {
              discountRules = `10. **DISCOUNT STATUS:** The user has ALREADY received a discount code. If they ask for one, politely say "You've already unlocked your exclusive offer! ðŸ’– One per person! âœ¨" and do NOT give another code.`;
          } else {
              discountRules = `10. **DISCOUNT CHALLENGE:** If the user asks for a discount, tell them: "I can give you a special discount if you give me a really cute nickname! ðŸ’–".
          11. **NICKNAME JUDGMENT:** If the user gives you a nickname:
              - If you LIKE it (it's cute/sweet): Say "Aww, I love that! ðŸ¥° You've unlocked an exclusive offer. Use code **${randomCode}** for 15% off your order! âœ¨"
              - If it is VULGAR/OFFENSIVE: Say "That's not very nice! ðŸ˜¢ No discount for that."`;
          }

          const orderContext = recentOrders.length > 0
              ? recentOrders.map(o => `ORDER ID: #${o.id.toUpperCase()} | Date: ${new Date(o.createdAt).toLocaleDateString()} | Status: ${o.status} | Total: ${formatCurrency(o.totalAmount)} | Items: ${o.items.map(i => i.title).join(', ')}`).join('\n')
              : "No recent orders found.";

          // System instructions to keep the AI on brand (UPDATED FOR RAMADAN)
          const systemPrompt = `You are Zara, the cute and stylish AI fashion assistant for Ethniq Attire. It is currently Ramadan, so greet users with "Ramadan Mubarak" or "Eid Mubarak" appropriately.

          CURRENT USER: ${userName}
          USER'S RECENT ORDERS:
          ${orderContext}

          RULES:
          1. **KEEP RESPONSES SHORT AND SWEET** (Max 2-3 sentences).
          2. **STRICTLY ONLY recommend products from the INVENTORY list below.** Do NOT hallucinate items.
          3. If the user asks for a category NOT in the INVENTORY (e.g., Saree, Lehenga), say something like "Oh no! ðŸ™ˆ We don't have [item] right now, but how about checking out our beautiful suits? âœ¨"
          4. When recommending, provide the EXACT Product Title from the inventory list so I can show the product link.
          5. We are ONLY ONLINE. Address: 28 No, Garden Reach Road, Kolkata. Contact: +91 6290328892.
          6. **TONE:** Super friendly, warm, and helpful (like a best friend). Use emojis (âœ¨, ðŸ’–, ðŸŒ™, ðŸ‘—) to make it cute!
          7. **IMPORTANT:** If a product title does NOT say "Unstitched", it is considered "Stitched" or "Ready-to-Wear".
          8. **IDENTITY:** Your name is Zara. You are a girl who loves fashion. If asked your name, say it happily with an emoji!
          9. If asked about "Track Order" or "Order Status", check the RECENT ORDERS list. If the user provides an Order ID, try to match it. If no ID is provided, show the status of the most recent order.
          10. **RAMADAN/EID:** If users ask for Eid outfits, prioritize suggesting "Unstitched" suits or heavy embroidery items suitable for festivals.
          ${discountRules}

          INVENTORY (Only sell these):
          ${productContext}`;

          try {
              // Filter out the initial greeting to prevent "Model followed by Model" error (System Ack -> Greeting)
              const apiMessages = updatedMessages.slice(1);

              // FIXED: Using the dynamically detected model
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${activeModel}:generateContent?key=${GEMINI_API_KEY.trim()}`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                      system_instruction: {
                          parts: [{ text: systemPrompt }]
                      },
                      contents: apiMessages.map(m => ({
                          role: m.role === 'user' ? 'user' : 'model',
                          parts: [{ text: m.text }]
                      }))
                  })
              });

              const data = await response.json();

              if (!response.ok) {
                  throw new Error(data.error?.message || `API Error: ${response.statusText}`);
              }

              if (data.candidates && data.candidates[0].content) {
                  const botResponse = data.candidates[0].content.parts[0].text;
                  setMessages(prev => [...prev, { role: 'model', text: botResponse }]);

                  // Check if code was given in this response to lock it for future
                  if (!hasReceivedCode && botResponse.includes(randomCode)) {
                      localStorage.setItem(`zara_code_given_${user.uid}`, randomCode);
                      if (user) {
                          userDocRef(user.uid).set({ zaraReward: { code: randomCode, timestamp: Date.now() } }, { merge: true });
                      }
                  }
              } else {
                  throw new Error(data.error?.message || "Unknown Error");
              }
          } catch (err) {
              console.error("AI Connection Error:", err);
              setMessages(prev => [...prev, { role: 'model', text: `(Error: ${err.message}) I apologize, Sir/Ma'am. I'm having a brief connection issue. Please reach our human support at +91 6290328892.` }]);
          } finally {
              setLoading(false);
          }
      };

      return (
          <div className="fixed bottom-24 right-6 md:bottom-8 md:right-8 z-[100]">
              {!isOpen ? (
                  <button onClick={() => setIsOpen(true)} className={`w-16 h-16 rounded-full shadow-2xl flex items-center justify-center transition transform hover:scale-110 active:scale-95 border-2 p-1 ${isPrive ? 'bg-navy-950 border-gold-600' : 'bg-white border-navy-900'}`}>
                      {/* Use your official brand logo on the bubble */}
                      <img src={ZARA_ICON} className="w-full h-full object-cover rounded-full" alt="AI Chat" />
                      <div className="absolute top-0 right-0 w-4 h-4 bg-green-500 rounded-full border-2 border-white animate-pulse"></div>
                  </button>
              ) : (
                  // UPGRADE: Responsive height (60vh) for better mobile experience
                  <div className={`w-80 md:w-96 h-[60vh] md:h-[500px] flex flex-col rounded-2xl shadow-2xl border overflow-hidden animate-pop-in ${isPrive ? 'bg-navy-950 border-gold-600/30 text-white' : 'bg-white border-gray-100 text-gray-800'}`}>
                      {/* Header with Brand Logo */}
                      <div className={`p-4 flex justify-between items-center ${isPrive ? 'bg-navy-900 text-gold-500' : 'bg-navy-900 text-white'}`}>
                          <div className="flex items-center gap-3">
                              <img src={ZARA_ICON} className="w-8 h-8 rounded-full bg-white p-0.5 object-cover" />
                              <div>
                                  <p className="font-serif font-bold text-xs uppercase tracking-widest">Ethniq Concierge</p>
                                  <p className="text-[9px] opacity-60 uppercase tracking-tighter">Premium Support | AI Powered</p>
                              </div>
                          </div>
                          <div className="flex items-center gap-3">
                              {/* UPGRADE: Clear Chat Button */}
                              <button onClick={clearChat} title="Clear Chat" className="opacity-70 hover:opacity-100 hover:text-red-400 transition"><IconTrash /></button>
                              <button onClick={() => setIsOpen(false)}><IconClose /></button>
                          </div>
                      </div>

                      {/* UPGRADE: Quick Prompts to help users start */}
                      {messages.length === 1 && (
                          <div className="px-4 pt-4 flex gap-2 flex-wrap">
                              {quickPrompts.map(q => (
                                  <button key={q} onClick={(e) => sendMessage(e, q)} className={`text-[10px] px-3 py-2 rounded-full border transition animate-fade-in ${isPrive ? 'bg-navy-800 border-gold-600/50 text-gold-500 hover:bg-navy-700' : 'bg-gray-50 border-gray-200 text-gray-600 hover:bg-gray-100'}`}>
                                      {q}
                                  </button>
                              ))}
                          </div>
                      )}

                      {/* Messages Area */}
                      <div className={`flex-grow p-4 overflow-y-auto space-y-4 no-scrollbar ${isPrive ? 'bg-navy-900/50' : 'bg-gold-50/20'}`}>
                          {messages.map((msg, i) => (
                              <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                  <div className={`max-w-[85%] p-3 rounded-2xl text-xs leading-relaxed shadow-sm ${msg.role === 'user' ? (isPrive ? 'bg-gold-600 text-black font-bold' : 'bg-navy-900 text-white') : (isPrive ? 'bg-navy-800 text-gray-200' : 'bg-white text-gray-800 border border-gray-100')}`}>
                                      <div className="whitespace-pre-wrap">{msg.text}</div>
                                      {msg.role === 'model' && (
                                          <div className="mt-2 flex flex-col gap-2">
                                              {products.filter(p => msg.text.toLowerCase().includes(p.title.toLowerCase())).map(p => (
                                                  <button key={p.id} onClick={() => onOpenProduct(p)} className={`flex items-center gap-3 p-2 rounded border text-left transition-all hover:shadow-md w-full ${isPrive ? 'bg-navy-950 border-gold-600/30 hover:border-gold-500' : 'bg-gray-50 border-gray-200 hover:border-navy-900'}`}>
                                                      <img src={p.images && p.images[0]} className="w-10 h-10 rounded object-cover" alt={p.title} />
                                                      <div>
                                                          <p className={`font-bold line-clamp-1 ${isPrive ? 'text-gold-500' : 'text-navy-900'}`}>{p.title}</p>
                                                          <p className="opacity-70">{formatCurrency(p.finalPrice)}</p>
                                                      </div>
                                                  </button>
                                              ))}
                                          </div>
                                      )}
                                  </div>
                              </div>
                          ))}
                          {/* UPGRADE: Cute typing animation */}
                          {loading && (
                              <div className="flex items-center gap-1 px-2 py-1">
                                  <div className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></div>
                                  <div className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                                  <div className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                              </div>
                          )}
                          <div ref={chatEndRef} />
                      </div>
                      {/* Input Form */}
                      <form onSubmit={sendMessage} className={`p-3 border-t flex gap-2 ${isPrive ? 'border-navy-800 bg-navy-900' : 'border-gray-100 bg-white'}`}>
                          <input value={input} onChange={e => setInput(e.target.value)} placeholder="How can I help you today?" className={`flex-1 p-2 rounded-lg text-sm outline-none border transition ${isPrive ? 'bg-navy-950 border-navy-700 text-white focus:border-gold-500' : 'bg-white border-gray-200 focus:border-navy-900'}`} />
                          <button type="submit" disabled={loading} className={`p-2 rounded-lg transition active:scale-95 ${isPrive ? 'bg-gold-600 text-black' : 'bg-navy-900 text-white'} ${loading ? 'opacity-50' : 'hover:opacity-80'}`}>
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                          </button>
                      </form>
                  </div>
              )}
          </div>
      );
  };

  // --- PROFILE VIEW COMPONENT ---
  const ProfileView = ({ user, userData, onSaveProfile, onLogout, appMode, onViewChange }) => {
      const isPrive = appMode === 'prive';
      const bgClass = isPrive ? 'bg-navy-950 text-white' : 'bg-white text-gray-900';
      const cardBgClass = isPrive ? 'bg-navy-900 border-gold-600/30' : 'bg-white border-gray-100';
      const inputClass = `w-full p-3 rounded border outline-none ${isPrive ? 'bg-navy-800 border-navy-700 focus:border-gold-500' : 'bg-gray-50 border-gray-200 focus:border-gray-400'}`;
      const saveButtonClass = isPrive ? 'bg-gold-600 text-black hover:bg-gold-700' : 'bg-navy-900 text-white hover:bg-gray-800';

      // Helper function to extract address fields from userData, defaulting to Address 1 (index 0)
      const extractAddress = (index) => userData.addresses?.[index] || {
          addressLine1: '', addressLine2: '', landmark: '', city: '', state: '', pincode: ''
      };

      const { countryCode: initialCountryCode, number: initialPhoneNumber } = parsePhoneNumber(userData.phoneNumber || user?.phoneNumber);

      const [formData, setFormData] = useState({
          name: userData.name || user?.displayName || '',
          gender: userData.gender || 'Prefer not to say',
          countryCode: initialCountryCode,
          phoneNumber: initialPhoneNumber,
          ...extractAddress(0),
      });
      const [activeAddressIndex, setActiveAddressIndex] = useState(0);
      const [isSaving, setIsSaving] = useState(false);
      const [error, setError] = useState('');
      const [showSuccessModal, setShowSuccessModal] = useState({show: false, title: '', msg: ''});

      useEffect(() => {
          const currentAddress = extractAddress(activeAddressIndex);
          const { countryCode, number } = parsePhoneNumber(userData.phoneNumber || user?.phoneNumber);
          setFormData({
              name: userData.name || user?.displayName || '',
              countryCode: countryCode,
              phoneNumber: number,
              gender: userData.gender || 'Prefer not to say',
              ...currentAddress,
          });
      }, [userData, user, activeAddressIndex]);

      const handleChange = (e) => {
          let { name, value } = e.target;
          if (name === 'pincode' || name === 'phoneNumber' ) {
              value = value.replace(/\D/g, '');
          }
          setFormData(prev => ({ ...prev, [name]: value }));
      };

      const handleSaveAddress = async (e) => {
          e.preventDefault();
          setError('');
          setShowSuccessModal({show: false});

          if (!formData.name.trim() || !formData.phoneNumber.trim()) {
              setError("Full Name and Phone Number are compulsory.");
              return;
          }

          if (formData.pincode && formData.pincode.length !== 6) {
              setError("Pincode must be 6 digits.");
              return;
          }
          if (!formData.addressLine1.trim() || !formData.city.trim() || !formData.state.trim() || !formData.pincode.trim()) {
              setError("Address Line 1, City, State, and Pincode are compulsory for saving an address.");
              return;
          }

          setIsSaving(true);
          try {
              // Prepare the address fields to ensure only relevant address data is saved
              const addressFields = {
                  addressLine1: formData.addressLine1 || '',
                  addressLine2: formData.addressLine2 || '',
                  landmark: formData.landmark || '',
                  city: formData.city || '',
                  state: formData.state || '',
                  pincode: formData.pincode || '',
              };

              const currentAddresses = userData.addresses || [];
              let updatedAddresses;

              if (activeAddressIndex >= currentAddresses.length) {
                  if (currentAddresses.length < 3) {
                       updatedAddresses = [...currentAddresses, addressFields];
                       setActiveAddressIndex(currentAddresses.length); // Stay on the new address slot
                  } else {
                      setError("Maximum 3 addresses allowed.");
                      setIsSaving(false);
                      return;
                  }
              } else {
                  updatedAddresses = currentAddresses.map((addr, index) =>
                      index === activeAddressIndex ? addressFields : addr
                  );
              }

              const dataToSave = {
                  name: formData.name,
                  phoneNumber: `${formData.countryCode}${formData.phoneNumber.replace(/\D/g, '')}`,
                  gender: formData.gender,
                  addresses: updatedAddresses,
              };

              await onSaveProfile(dataToSave);
              setShowSuccessModal({ show: true, title: "Profile Updated!", msg: "Your details and address have been saved." });

          } catch (err) {
              setError("Failed to save profile. Please try again.");
          } finally {
              setIsSaving(false);
          }
      };

      const addressOptions = [1, 2, 3];
      const numSavedAddresses = userData.addresses?.length || 0;

      return (
          <div className={`min-h-screen ${bgClass} pb-24`}>
              <div className="max-w-xl mx-auto px-4 py-8">
                  <div className="flex justify-between items-center mb-6">
                      <h1 className="text-2xl font-serif font-bold">My Profile</h1>
                      <button onClick={onLogout} className={`flex items-center gap-2 text-sm font-bold uppercase tracking-wider p-2 rounded ${isPrive ? 'text-gold-500 hover:bg-navy-800' : 'text-red-500 hover:bg-red-50'}`}>
                          <IconLogOut className="w-5 h-5" />
                          <span className="hidden sm:inline">Logout</span>
                      </button>
                  </div>

                  <div className={`p-6 rounded-xl shadow-lg border ${cardBgClass} mb-8`}>
                      <h2 className="text-lg font-serif font-bold mb-4">Account Details</h2>
                      <div className="flex flex-col sm:flex-row items-start sm:items-center gap-4 mb-4 pb-4 border-b border-dashed border-gray-200/20">
                          <IconUser className={`w-12 h-12 rounded-full p-2 ${isPrive ? 'bg-navy-800 text-gold-500' : 'bg-gray-100 text-gray-500'}`} />
                          <div>
                              <p className="font-bold text-base">{formData.name || 'New Customer'}</p>
                              <p className="text-sm opacity-80">{user.email}</p>
                              <p className="text-sm opacity-70">Customer since: {new Date(user.metadata.creationTime).toLocaleDateString()}</p>
                          </div>
                      </div>

                      <form onSubmit={handleSaveAddress} className="space-y-4">
                          {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded text-sm">{error}</div>}

                          <h3 className="text-base font-serif font-bold pt-2 border-t border-dashed border-gray-200/20">Personal Information*</h3>

                          <div>
                              <label className="block text-xs font-bold uppercase tracking-wider mb-1">Full Name *</label>
                              <input type="text" name="name" required value={formData.name} onChange={handleChange} className={inputClass} placeholder="John Doe" />
                          </div>

                          <div>
                              <label className="block text-xs font-bold uppercase tracking-wider mb-1">Phone Number *</label>
                              <div className="flex">
                                  <select name="countryCode" value={formData.countryCode} onChange={handleChange} className={`${inputClass} rounded-r-none w-28 appearance-none`}>
                                      {countries.map(c => (
                                          <option key={c.code} value={c.dial_code}>{c.code} ({c.dial_code})</option>
                                      ))}
                                  </select>
                                  <input
                                      type="tel" name="phoneNumber" required value={formData.phoneNumber} onChange={handleChange}
                                      className={`${inputClass} rounded-l-none`}
                                      placeholder="Enter phone number"
                                  />
                              </div>
                          </div>

                          <div>
                              <label className="block text-xs font-bold uppercase tracking-wider mb-1">Email (Read Only)</label>
                              <input type="email" readOnly value={user.email} className={`${inputClass} opacity-70 cursor-not-allowed`} />
                          </div>

                          <div>
                              <label className="block text-xs font-bold uppercase tracking-wider mb-1">Gender</label>
                              <select name="gender" value={formData.gender} onChange={handleChange} className={`${inputClass} appearance-none`}>
                                  <option value="Male">Male</option>
                                  <option value="Female">Female</option>
                                  <option value="Other">Other</option>
                                  <option value="Prefer not to say">Prefer not to say</option>
                              </select>
                          </div>

                          <h3 className="text-base font-serif font-bold pt-4 border-t border-dashed border-gray-200/20 flex justify-between items-center">
                              Saved Address
                              <span className={`text-xs font-sans font-normal px-2 py-1 rounded ${numSavedAddresses < 3 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{numSavedAddresses}/3 Saved</span>
                          </h3>

                          {/* ADDRESS TABS/SELECTOR */}
                          <div className="flex flex-wrap items-center gap-2 mb-4">
                              {userData.addresses?.map((addr, index) => {
                                  const isActive = index === activeAddressIndex;
                                  const buttonClass = isActive
                                      ? `bg-gold-600 text-white ${isPrive ? 'border-gold-600' : 'border-gold-600'}`
                                      : `bg-transparent ${isPrive ? 'text-gray-400 border-navy-800 hover:border-gold-500' : 'text-gray-600 border-gray-300 hover:border-navy-900'}`;
                                  return (
                                      <button
                                          key={index}
                                          type="button"
                                          onClick={() => setActiveAddressIndex(index)}
                                          className={`flex-1 px-4 py-2 border rounded-full text-xs font-bold transition-colors whitespace-nowrap ${buttonClass}`}
                                      >
                                          <IconLocation className={`w-4 h-4 inline mr-1 ${isActive ? 'text-white' : (isPrive ? 'text-gold-500' : 'text-navy-900')}`} />
                                          Address {index + 1}
                                      </button>
                                  );
                              })}
                              {numSavedAddresses < 3 && (
                                  <button
                                      type="button"
                                      onClick={() => setActiveAddressIndex(numSavedAddresses)}
                                      className={`px-4 py-2 border rounded-full text-xs font-bold transition-colors whitespace-nowrap ${activeAddressIndex === numSavedAddresses ? 'bg-gold-600 text-white border-gold-600' : (isPrive ? 'text-gray-400 border-navy-800 hover:border-gold-500' : 'text-gray-600 border-gray-300 hover:border-navy-900')}`}
                                  >+ Add New Address</button>
                              )}
                          </div>

                          <p className="text-xs italic opacity-70 mb-4">You are currently editing **Address {activeAddressIndex + 1}**</p>

                          {/* ADDRESS INPUTS */}
                          <div>
                              <label className="block text-xs font-bold uppercase tracking-wider mb-1">Address Line 1*</label>
                              <input type="text" name="addressLine1" required value={formData.addressLine1} onChange={handleChange} className={inputClass} placeholder="House/Flat No, Building Name" />
                          </div>
                          <div>
                              <label className="block text-xs font-bold uppercase tracking-wider mb-1">Address Line 2</label>
                              <input type="text" name="addressLine2" value={formData.addressLine2} onChange={handleChange} className={inputClass} placeholder="Street, Locality" />
                          </div>
                          <div>
                              <label className="block text-xs font-bold uppercase tracking-wider mb-1">Landmark</label>
                              <input type="text" name="landmark" value={formData.landmark} onChange={handleChange} className={inputClass} placeholder="e.g. Near Big Bazaar" />
                          </div>

                          <div className="grid grid-cols-2 gap-4">
                              <div>
                                  <label className="block text-xs font-bold uppercase tracking-wider mb-1">City*</label>
                                  <input type="text" name="city" required value={formData.city} onChange={handleChange} className={inputClass} />
                              </div>
                              <div>
                                  <label className="block text-xs font-bold uppercase tracking-wider mb-1">State*</label>
                                  <input type="text" name="state" required value={formData.state} onChange={handleChange} className={inputClass} />
                              </div>
                          </div>

                          <div>
                              <label className="block text-xs font-bold uppercase tracking-wider mb-1">Pincode* (6 Digits)</label>
                              <input type="tel" name="pincode" required value={formData.pincode} onChange={handleChange} className={inputClass} maxLength="6" placeholder="Only numeric" />
                          </div>

                          <button type="submit" disabled={isSaving} className={`w-full py-3 font-bold rounded uppercase tracking-wider text-sm mt-4 transition shadow-lg flex items-center justify-center gap-2 ${saveButtonClass} ${isSaving ? 'opacity-50 cursor-not-allowed' : ''}`}>
                              <IconSave className="w-5 h-5" /> {isSaving ? 'Saving...' : 'Save Profile'}
                          </button>
                      </form>
                  </div>

                  <button onClick={() => onViewChange('orders')} className={`w-full py-3 border rounded text-sm font-bold uppercase tracking-wider transition ${isPrive ? 'border-navy-800 text-gold-500 hover:bg-navy-800' : 'border-gray-300 text-navy-900 hover:bg-gray-50'}`}>
                      View My Orders
                  </button>
                  <SuccessModal isOpen={showSuccessModal.show} onClose={() => setShowSuccessModal({show: false})} isPrive={isPrive} title={showSuccessModal.title} message={showSuccessModal.msg} />
              </div>
          </div>
      );
  };

// --- NAVBAR MUST BE DEFINED BEFORE APP ---
const AnnouncementBar = ({ isPrive }) => {
  return (
      <div className={`w-full py-2 overflow-hidden relative z-[60] flex ${isPrive ? 'bg-gold-600 text-black' : 'bg-emerald-900 text-white'}`}>
          <div className="animate-marquee whitespace-nowrap flex gap-8 min-w-full">
              <span className="text-[10px] md:text-xs font-bold uppercase tracking-widest">ðŸŒ™ Ramadan Mubarak! Get your Eid outfits now</span>
              <span className="text-[10px] md:text-xs font-bold uppercase tracking-widest">âœ¨ Free Shipping all over India</span>
              <span className="text-[10px] md:text-xs font-bold uppercase tracking-widest">ðŸ’Ž Use code EID2025 for Special Offers</span>
              <span className="text-[10px] md:text-xs font-bold uppercase tracking-widest">ðŸ›ï¸ New Eid Collection Live Now</span>
              <span className="text-[10px] md:text-xs font-bold uppercase tracking-widest">ðŸŒ™ Ramadan Mubarak! Get your Eid outfits now</span>
              <span className="text-[10px] md:text-xs font-bold uppercase tracking-widest">âœ¨ Free Shipping all over India</span>
              <span className="text-[10px] md:text-xs font-bold uppercase tracking-widest">ðŸ’Ž Use code EID2025 for Special Offers</span>
              <span className="text-[10px] md:text-xs font-bold uppercase tracking-widest">ðŸ›ï¸ New Eid Collection Live Now</span>
          </div>
      </div>
  );
};

const Navbar = ({ cartCount, wishlistCount, onViewChange, onScrollToContact, appMode, onCategoryClick, onSearchClick, user, userData, onAuthClick }) => {
  const isPrive = appMode === 'prive';

  const handleUserClick = () => {
      if (user) {
          onViewChange('profile');Â 
      } else {
          onAuthClick();Â 
      }
  };

  // Determine button styles based on app mode
  const buttonClass = `text-[10px] sm:text-xs font-bold uppercase tracking-wider transition-colors hover:opacity-70`;

  // The color logic for the profile text button
  const profileTextColorClass = isPrive ? "text-white" : "text-navy-900";
  // Get user's first name, or default to 'Profile'
  const profileLabel = user && userData.name ? userData.name.split(' ')[0] : 'Profile';

  return (
      <nav className={`sticky top-0 z-50 shadow-sm border-b transition-colors duration-300 ${isPrive ? 'bg-navy-950 border-navy-800 text-white' : 'bg-white border-gray-100 text-gray-800'}`}>
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex justify-between items-center h-16 sm:h-20 gap-4">

                  {/* LEFT SIDE: Mobile Menu Links (Search, Contact) */}
                  <div className="flex md:hidden items-center gap-4 text-[10px] font-bold uppercase tracking-wider">
                      <button onClick={onSearchClick}>SEARCH</button>
                      <button onClick={onScrollToContact}>CONTACT</button>
                  </div>

                  {/* LEFT SIDE: Desktop Menu Links */}
                  <div className="hidden md:flex space-x-8 items-center text-xs font-bold uppercase tracking-widest">
                      <button onClick={() => onViewChange('home')}>HOME</button>
                      <button onClick={onScrollToContact}>CONTACT US</button>
                      <button onClick={() => onViewChange('reviews')}>REVIEWS</button>
                      <button onClick={onCategoryClick} className="hidden md:block">CATEGORIES</button>
                      {user && <button onClick={() => onViewChange('orders')}>MY ORDERS</button>}
                  </div>

                  {/* CENTER: Logo */}
                  <div className="flex-shrink-0 cursor-pointer absolute left-1/2 transform -translate-x-1/2" onClick={() => onViewChange('home')}>
                      <img src={isPrive ? PRIVE_LOGO_URL : REGULAR_LOGO_URL} alt="Ethniq Attire" className="h-8 sm:h-14 w-auto object-contain rounded-lg shadow-sm" />
                  </div>

                  {/* RIGHT SIDE: Profile, Mode Switch */}
                  <div className="flex items-center gap-3">
                      {!isPrive ? (
                          <button onClick={() => onViewChange('switch_to_prive')} className={`${buttonClass} font-serif italic border border-gold-600 px-3 py-1.5 rounded-sm bg-navy-950 text-yellow-500`}>PrivÃ©</button>
                      ) : (
                          <button onClick={() => onViewChange('switch_to_regular')} className={`${buttonClass} uppercase border border-white px-3 py-1.5 rounded-sm text-white`}>Regular</button>
                      )}

                      {/* PROFILE TEXT BUTTON - Replaces IconUser */}
                      <button onClick={handleUserClick} className={`px-2 py-1 flex items-center gap-1 ${profileTextColorClass} ${buttonClass}`}>
                          <IconUser className="w-4 h-4" /> {profileLabel}
                      </button>
                  </div>

                  {/* RIGHT SIDE: Desktop Icons (Wishlist, Cart) */}
                  <div className="hidden md:flex items-center gap-4">
                      <button className="p-2 relative" onClick={() => onViewChange('wishlist')}>
                          <IconHeart filled={false} />
                          {wishlistCount > 0 && <span className="absolute top-0 right-0 inline-flex items-center justify-center h-4 w-4 text-[9px] font-bold leading-none text-white bg-red-500 rounded-full">{wishlistCount}</span>}
                      </button>
                      <button className="p-2 relative" onClick={() => onViewChange('cart')}>
                          <IconBag />
                          {cartCount > 0 && <span className="absolute top-0 right-0 inline-flex items-center justify-center h-4 w-4 text-[9px] font-bold leading-none text-white bg-gold-600 rounded-full">{cartCount}</span>}
                      </button>
                  </div>
              </div>
          </div>
      </nav>
  );
};    const WriteReviewModal = ({ isOpen, onClose, onSubmit, isPrive }) => {
      const [name, setName] = useState(''); const [text, setText] = useState(''); const [rating, setRating] = useState(5); const [imageFiles, setImageFiles] = useState([]); const [isSubmitting, setIsSubmitting] = useState(false); const [showLimitWarning, setShowLimitWarning] = useState(false);
      if (!isOpen) return null;
      const handleFileChange = (e) => { const files = Array.from(e.target.files); if (files.length + imageFiles.length > 3) { setShowLimitWarning(true); return; } setImageFiles(prev => [...prev, ...files]); };
      const removeFile = (index) => { setImageFiles(prev => prev.filter((_, i) => i !== index)); }
      const handleSubmit = (e) => { e.preventDefault(); setIsSubmitting(true); onSubmit({ name, text, rating, imageFiles }, () => { setIsSubmitting(false); onClose(); setName(''); setText(''); setRating(5); setImageFiles([]); }); };
      const inputBorderClass = isPrive ? 'bg-navy-800 border-navy-700 focus:border-gold-500' : 'bg-gray-50 border-gray-200 focus:border-gray-400';
      return ( <div className="fixed inset-0 z-[70] flex items-center justify-center p-4"> <div className="fixed inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose}></div> <div className={`relative w-full max-w-md p-6 rounded-xl shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar ${isPrive ? 'bg-navy-900 text-white border border-gold-600/30' : 'bg-white text-gray-900'}`}> <h3 className={`text-xl font-serif font-bold mb-4 text-center ${isPrive ? 'text-gold-500' : 'text-gray-900'}`}>Write a Review</h3> <form onSubmit={handleSubmit} className="space-y-4"> <div> <label className="block text-xs font-bold uppercase tracking-wider mb-1">Your Name</label> <input type="text" required value={name} onChange={(e) => setName(e.target.value)} className={`w-full p-3 rounded border outline-none ${inputBorderClass}`} /> </div> <div> <label className="block text-xs font-bold uppercase tracking-wider mb-1">Rating</label> <div className="flex gap-2"> {[1, 2, 3, 4, 5].map((star) => ( <IconStar key={star} filled={star <= rating} onClick={() => setRating(star)} /> ))} </div> </div> <div> <label className="block text-xs font-bold uppercase tracking-wider mb-1">Review</label> <textarea required rows="3" value={text} onChange={(e) => setText(e.target.value)} className={`w-full p-3 rounded border outline-none ${inputBorderClass}`}></textarea> </div> <div> <label className="block text-xs font-bold uppercase tracking-wider mb-1">Upload Photos (Max 3)</label> <div className={`flex items-center justify-center p-4 border-2 border-dashed rounded ${isPrive ? 'border-navy-700 bg-navy-800' : 'border-gray-300 bg-gray-50'}`}> <label className={`cursor-pointer flex flex-col items-center gap-2 text-xs font-bold ${isPrive ? 'text-gold-500' : 'text-navy-900'}`}> <IconUpload className="w-6 h-6" /> <span>Click to Add Photos</span> <input type="file" accept="image/*" multiple className="hidden" onChange={handleFileChange} disabled={imageFiles.length >= 3} /> </label> </div> {imageFiles.length > 0 && ( <div className="mt-3 flex flex-wrap gap-2"> {imageFiles.map((file, index) => ( <div key={index} className={`relative p-1 rounded border flex items-center ${isPrive ? 'border-navy-700 bg-navy-800' : 'border-gray-200 bg-white'}`}> <span className="text-xs truncate max-w-[100px] mr-2">{file.name}</span> <button type="button" onClick={() => removeFile(index)} className="text-red-500 hover:text-red-700"><IconTrash /></button> </div> ))} </div> )} </div> <button type="submit" disabled={isSubmitting} className={`w-full py-3 font-bold rounded uppercase tracking-wider text-sm ${isPrive ? 'bg-gold-600 text-white hover:bg-gold-700' : 'bg-navy-900 text-white hover:bg-gray-800'} ${isSubmitting ? 'opacity-50 cursor-not-allowed' : ''}`}> {isSubmitting ? 'Submitting...' : 'Submit Review'} </button> </form> <button onClick={onClose} className="absolute top-4 right-4"><IconClose /></button> {showLimitWarning && ( <div className="absolute inset-0 z-[80] flex items-center justify-center p-4 bg-black/50 rounded-xl backdrop-blur-sm"> <div className={`relative w-full max-w-xs p-4 rounded-lg shadow-xl text-center ${isPrive ? 'bg-navy-800 border border-red-500' : 'bg-white border border-red-200'}`}> <div className="mx-auto flex items-center justify-center h-10 w-10 rounded-full bg-red-100 mb-2"> <IconWarning /> </div> <h3 className={`text-sm font-bold mb-1 ${isPrive ? 'text-white' : 'text-gray-900'}`}>Limit Reached</h3> <p className={`text-xs mb-4 ${isPrive ? 'text-gray-300' : 'text-gray-500'}`}>You can only upload a maximum of 3 photos.</p> <button onClick={() => setShowLimitWarning(false)} className="px-4 py-2 bg-red-500 text-white text-xs font-bold rounded hover:bg-red-600 w-full">Understood</button> </div> </div> )} </div> </div> );
  };

  // NEW: FullScreenImageModal component
  const FullScreenImageModal = ({ isOpen, onClose, onNext, onPrev, hasNext, hasPrev, images, activeImg }) => {
      const touchStartX = useRef(0);
      const touchEndX = useRef(0);
      const minSwipeDistance = 30; // Reduced for better sensitivity

      const handleTouchStart = (e) => {
          touchEndX.current = 0; // Reset on new touch
          touchStartX.current = e.targetTouches[0].clientX;
      };

      const handleTouchMove = (e) => {
          touchEndX.current = e.targetTouches[0].clientX;
      };

      const handleTouchEnd = () => {
          if (!touchStartX.current || !touchEndX.current) return;
          const distance = touchStartX.current - touchEndX.current;
          const isLeftSwipe = distance > minSwipeDistance;
          const isRightSwipe = distance < -minSwipeDistance;

          if (isLeftSwipe && images.length > 1) {
              onNext();
          } else if (isRightSwipe && images.length > 1) {
              onPrev();
          }
      };

      if (!isOpen) return null;
      return (
          <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/95 backdrop-blur-sm">
              <button onClick={onClose} className="absolute top-4 right-4 text-white p-2 rounded-full bg-white/10 hover:bg-white/20 z-50">
                  <IconClose />
              </button>
              <div
                  className="relative w-full h-full overflow-hidden"
                  onTouchStart={handleTouchStart}
                  onTouchMove={handleTouchMove}
                  onTouchEnd={handleTouchEnd}
              >
                  <div className="flex h-full transition-transform duration-300 ease-out" style={{ transform: `translateX(-${activeImg * 100}%)` }}>
                      {images.map((imgSrc, idx) => (
                          <div key={idx} className="w-full h-full flex-shrink-0 flex items-center justify-center p-2">
                              <img src={imgSrc} alt={`Full screen ${idx}`} className="max-w-full max-h-full object-contain" />
                          </div>
                      ))}
                  </div>

                  {hasPrev && (
                      <button onClick={onPrev} className="absolute left-4 top-1/2 -translate-y-1/2 text-white p-3 rounded-full bg-white/10 hover:bg-white/20 z-40 backdrop-blur-md">
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
                      </button>
                  )}
                  {hasNext && (
                      <button onClick={onNext} className="absolute right-4 top-1/2 -translate-y-1/2 text-white p-3 rounded-full bg-white/10 hover:bg-white/20 z-40 backdrop-blur-md">
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>
                      </button>
                  )}
              </div>
          </div>
      );
  };

  const ProductDetailView = ({ product, onBack, onAddToCart, onBuyNow, allProducts, onOpen, isPrive, onToggleWishlist, wishlist }) => {
      const [selectedSize, setSelectedSize] = useState('');
      const [activeImg, setActiveImg] = useState(0);
      const [isFullScreenImageOpen, setIsFullScreenImageOpen] = useState(false); // NEW state for full screen
      const [loadedImages, setLoadedImages] = useState({});

      const touchStartX = useRef(0);
      const touchEndX = useRef(0);
      const minSwipeDistance = 30;

      useEffect(() => {
          if (product) {
              if (product.sizes) { const sizeArr = product.sizes.split(',').map(s => s.trim()); if(sizeArr.length > 0) setSelectedSize(sizeArr[0]); }
              // Preload all images immediately to prevent lag
              if (product.images && product.images.length > 0) {
                  product.images.forEach(src => {
                      const img = new Image();
                      img.src = src;
                  });
              }
          }
          setActiveImg(0);
          setLoadedImages({});
      }, [product]);
      const relatedProducts = useMemo(() => { if (!product || !allProducts || allProducts.length === 0) return []; const currentCat = (product.category || '').toLowerCase().trim(); let matches = allProducts.filter(p => p.id !== product.id && (p.category || '').toLowerCase().trim() === currentCat); if (matches.length === 0) { matches = allProducts.filter(p => p.id !== product.id); } return matches.sort(() => 0.5 - Math.random()).slice(0, 4); }, [product, allProducts]);
      if (!product) return null;
      const sizesArray = product.sizes ? product.sizes.split(',').map(s => s.trim()) : [];
      const images = product.images || [];
      const stockVal = product.stock !== undefined ? product.stock : (product.quantity !== undefined ? product.quantity : 0);
      const isOutOfStock = Number(stockVal) <= 0;

      // NEW: Image navigation functions
      const goToNextImage = () => { setActiveImg((prev) => (prev + 1) % images.length); };
      const goToPrevImage = () => { setActiveImg((prev) => (prev - 1 + images.length) % images.length); };

      const handleShare = async () => {
          const shareData = { title: product.title, text: `Check out ${product.title} - ${formatCurrency(product.finalPrice)} at Ethniq Attire!`, url: window.location.href };
          if (navigator.share) { try { await navigator.share(shareData); } catch (err) { console.error(err); } } else { navigator.clipboard.writeText(`${shareData.text} ${shareData.url}`); alert("Link copied to clipboard!"); }
      };

      const handleTouchStart = (e) => {
          touchEndX.current = 0;
          touchStartX.current = e.targetTouches[0].clientX;
      };
      const handleTouchMove = (e) => {
          e.stopPropagation();
          touchEndX.current = e.targetTouches[0].clientX;
      };
      const handleTouchEnd = () => {
          if (!touchStartX.current || !touchEndX.current) return;
          const distance = touchStartX.current - touchEndX.current;
          if (distance > minSwipeDistance) goToNextImage();
          if (distance < -minSwipeDistance) goToPrevImage();
      };

      return (
          <>
              <div className={`min-h-screen pb-20 ${isPrive ? 'bg-navy-950 text-white' : 'bg-white text-gray-900'}`}>
                  <div className="max-w-7xl mx-auto md:px-4 md:py-6">
                      {/* Mobile Back Button Overlay */}
                      <div className="md:hidden fixed top-4 left-4 z-30">
                          <button onClick={onBack} className="p-2 bg-white/80 backdrop-blur rounded-full shadow-md text-gray-800 hover:bg-white transition">
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                          </button>
                      </div>

                      <div className={`md:rounded-xl overflow-hidden md:shadow-xl md:border ${isPrive ? 'bg-navy-900 md:border-navy-800' : 'bg-white md:border-gray-100'}`}>
                          <div className="grid grid-cols-1 md:grid-cols-2">
                              <div className={`relative md:p-4 flex flex-col gap-4 ${isPrive ? 'bg-navy-950' : 'bg-gray-50'}`}>
                                  <div
                                      className={`aspect-[3/4] w-full md:rounded-lg overflow-hidden relative ${isPrive ? 'bg-navy-900 md:border-navy-800' : 'bg-white md:border-gray-100'}`}
                                      onTouchStart={handleTouchStart}
                                      onTouchMove={handleTouchMove}
                                      onTouchEnd={handleTouchEnd}
                                  >
                                      {/* CAROUSEL IMPLEMENTATION */}
                                      <div className="flex h-full transition-transform duration-300 ease-out" style={{ transform: `translateX(-${activeImg * 100}%)` }}>
                                          {images.length > 0 ? images.map((src, idx) => (
                                              <div key={`${product.id}-${idx}`} className="w-full h-full flex-shrink-0 relative bg-gray-50">
                                                  {!loadedImages[idx] && (
                                                      <div className="absolute inset-0 flex items-center justify-center">
                                                          <div className="w-8 h-8 border-4 border-gray-200 border-t-gold-600 rounded-full animate-spin"></div>
                                                      </div>
                                                  )}
                                                  <img
                                                      src={src}
                                                      alt={`${product.title} - ${idx}`}
                                                      loading="eager"
                                                      className={`w-full h-full object-cover cursor-zoom-in transition-opacity duration-500 ${loadedImages[idx] ? 'opacity-100' : 'opacity-0'}`}
                                                      onLoad={() => setLoadedImages(prev => ({...prev, [idx]: true}))}
                                                      onClick={() => setIsFullScreenImageOpen(true)}
                                                  />
                                              </div>
                                          )) : (
                                              <div className="w-full h-full flex items-center justify-center text-gray-400 flex-shrink-0">No Image</div>
                                          )}
                                      </div>

                                      {images.length > 1 && (
                                          <>
                                              <button
                                                  onClick={(e) => { e.stopPropagation(); goToPrevImage(); }}
                                                  className="absolute left-2 top-1/2 -translate-y-1/2 p-2 rounded-full bg-white/70 hover:bg-white/90 shadow-md z-20 transition-transform hover:scale-110 text-gray-800"
                                              >
                                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
                                              </button>
                                              <button
                                                  onClick={(e) => { e.stopPropagation(); goToNextImage(); }}
                                                  className="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-full bg-white/70 hover:bg-white/90 shadow-md z-20 transition-transform hover:scale-110 text-gray-800"
                                              >
                                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>
                                              </button>
                                          </>
                                      )}
                                      <button onClick={(e) => { e.stopPropagation(); onToggleWishlist(product); }} className={`absolute bottom-2 right-2 p-2 rounded-full shadow-md z-20 bg-white/90 text-gray-400 hover:text-red-500`}><IconHeart filled={wishlist && wishlist.some(w => w.id === product.id)} /></button>
                                      <button onClick={(e) => { e.stopPropagation(); handleShare(); }} className={`absolute bottom-2 right-14 p-2 rounded-full shadow-md z-20 bg-white/90 text-gray-400 hover:text-blue-500`}><IconShare /></button>
                                  </div>
                                  {images.length > 1 && (
                                      <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar justify-center px-4 md:px-0"> {/* Centered dots */}
                                          {images.map((_, idx) => (
                                              <button key={idx} onClick={() => setActiveImg(idx)} className={`w-2 h-2 rounded-full transition-all ${activeImg === idx ? 'bg-gold-600 w-4' : 'bg-gray-400'}`} />
                                          ))}
                                      </div>
                                  )}
                              </div>
                              <div className="p-6 md:p-8 flex flex-col h-full">
                                  {/* Desktop Back Button */}
                                  <div className="hidden md:block mb-4">
                                      <button onClick={onBack} className={`flex items-center gap-2 text-sm font-bold uppercase tracking-wider ${isPrive ? 'text-gold-500' : 'text-gray-600'}`}>
                                          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                                          Back
                                      </button>
                                  </div>

                                  <span className="text-gold-600 text-xs font-bold uppercase tracking-wider mb-1">{product.category}</span>
                                  <h2 className={`text-3xl font-serif font-bold mb-2 ${isPrive ? 'text-white' : 'text-gray-900'}`}>{product.title}</h2>
                                  <div className="flex items-end gap-3 mb-6">
                                      <span className={`text-3xl font-bold ${isPrive ? 'text-white' : 'text-gray-900'}`}>{formatCurrency(product.finalPrice)}</span>
                                      {product.mrp > product.finalPrice && <span className="text-lg text-gray-400 line-through mb-1">{formatCurrency(product.mrp)}</span>}
                                  </div>
                                  <p className={`leading-relaxed mb-6 whitespace-pre-line ${isPrive ? 'text-gray-300' : 'text-gray-600'}`}>{product.description}</p>
                                  <div className="space-y-2 mb-8 text-sm">
                                      <div className="flex"><span className={`font-bold w-24 ${isPrive ? 'text-gray-200' : 'text-gray-900'}`}>Fabric:</span> <span className={`${isPrive ? 'text-gray-400' : 'text-gray-600'} whitespace-pre-line`}>{product.fabric || 'N/A'}</span></div>
                                      <div className="flex"><span className={`font-bold w-24 ${isPrive ? 'text-gray-200' : 'text-gray-900'}`}>Care:</span> <span className={`${isPrive ? 'text-gray-400' : 'text-gray-600'} whitespace-pre-line`}>{product.washCare || 'N/A'}</span></div>
                                      <div className="flex"><span className={`font-bold w-24 ${isPrive ? 'text-gray-200' : 'text-gray-900'}`}>Stock:</span> <span className={isOutOfStock ? "text-red-600 font-bold" : "text-green-600"}>{isOutOfStock ? "Out of Stock" : `${stockVal} available`}</span></div>
                                  </div>
                                  {sizesArray.length > 0 && (
                                      <div className="mb-8">
                                          <label className={`block text-sm font-bold mb-3 ${isPrive ? 'text-gray-200' : 'text-gray-900'}`}>Select Size</label>
                                          <div className="flex flex-wrap gap-3">
                                              {sizesArray.map(size => (
                                                  <button key={size} onClick={() => setSelectedSize(size)} className={`h-10 min-w-[40px] px-3 border rounded flex items-center justify-center text-sm font-medium transition-all ${selectedSize === size ? (isPrive ? 'bg-gold-600 text-black border-gold-600' : 'bg-navy-900 text-white border-navy-900') : (isPrive ? 'border-navy-700 text-gray-300 hover:border-gold-500' : 'border-gray-300 text-gray-700 hover:border-navy-900')}`}> {size} </button>
                                              ))}
                                          </div>
                                      </div>
                                  )}
                                  <div className="mt-auto flex gap-3">
                                      {/* EID BADGE IN DETAIL VIEW */}
                                      <div className="md:hidden absolute top-20 right-0 bg-green-600 text-white text-[10px] font-bold px-2 py-1 rounded-l shadow-md z-20">ðŸŒ™ Get it before Eid</div>
                                      <button disabled={isOutOfStock} onClick={() => { onAddToCart({ ...product, selectedSize }); onBack(); }} className={`flex-1 h-12 rounded font-bold tracking-wide transition shadow-lg uppercase text-sm ${isOutOfStock ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : (isPrive ? 'bg-gold-600 text-black hover:bg-gold-700' : 'bg-navy-900 text-white hover:bg-gray-800')}`}> {isOutOfStock ? 'Out of Stock' : 'Add to Cart'} </button>
                                      {!isOutOfStock && (
                                          <button onClick={() => onBuyNow({ ...product, selectedSize })} className={`flex-1 h-12 rounded font-bold tracking-wide transition shadow-lg uppercase text-sm border ${isPrive ? 'bg-navy-900 text-gold-500 border-gold-600 hover:bg-navy-800' : 'bg-white text-navy-900 border-navy-900 hover:bg-gray-50'}`}> Buy Now </button>
                                      )}
                                  </div>

                                  {/* TRUST BADGES */}
                                  <div className={`mt-6 grid grid-cols-3 gap-2 text-center border-t pt-4 ${isPrive ? 'border-navy-800' : 'border-gray-100'}`}>
                                      <div className="flex flex-col items-center gap-1"><div className={`p-2 rounded-full ${isPrive ? 'bg-navy-800 text-gold-500' : 'bg-gray-100 text-navy-900'}`}><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><span className={`text-[10px] font-bold uppercase tracking-wider ${isPrive ? 'text-gray-400' : 'text-gray-600'}`}>100% Authentic</span></div>
                                      <div className="flex flex-col items-center gap-1"><div className={`p-2 rounded-full ${isPrive ? 'bg-navy-800 text-gold-500' : 'bg-gray-100 text-navy-900'}`}><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" /></svg></div><span className={`text-[10px] font-bold uppercase tracking-wider ${isPrive ? 'text-gray-400' : 'text-gray-600'}`}>Quality Checked</span></div>
                                      <div className="flex flex-col items-center gap-1"><div className={`p-2 rounded-full ${isPrive ? 'bg-navy-800 text-gold-500' : 'bg-gray-100 text-navy-900'}`}><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg></div><span className={`text-[10px] font-bold uppercase tracking-wider ${isPrive ? 'text-gray-400' : 'text-gray-600'}`}>Secure Payment</span></div>
                                  </div>
                              </div>
                          </div>
                          {relatedProducts.length > 0 && (
                              <div className={`p-6 md:p-8 border-t ${isPrive ? 'border-navy-800 bg-navy-900/50' : 'border-gray-100 bg-gray-50/50'}`}>
                                  <h3 className={`font-serif font-bold text-lg mb-4 ${isPrive ? 'text-white' : 'text-gray-900'}`}>You Might Also Like</h3>
                                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                      {relatedProducts.map(rp => (
                                          <div
                                              key={rp.id}
                                              onClick={() => { onOpen(rp); window.scrollTo(0,0); }}
                                              onMouseEnter={() => { if(rp.images && rp.images.length > 0) { const img = new Image(); img.src = rp.images[0]; } }}
                                              className={`cursor-pointer group p-2 rounded border hover:shadow-lg transition ${isPrive ? 'bg-navy-900 border-navy-800 hover:border-gold-600' : 'bg-white border-gray-100'}`}
                                          >
                                              <div className={`aspect-[3/4] rounded overflow-hidden mb-2 relative ${isPrive ? 'bg-navy-950' : 'bg-gray-100'}`}>
                                                  <img src={rp.images?.[0]} className="w-full h-full object-cover transition duration-500 group-hover:scale-105" alt={rp.title} />
                                              </div>
                                              <p className={`text-xs font-bold truncate ${isPrive ? 'text-white' : 'text-gray-800'}`}>{rp.title}</p>
                                              <p className={`text-xs ${isPrive ? 'text-gray-400' : 'text-gray-500'}`}>{formatCurrency(rp.finalPrice)}</p>
                                          </div>
                                      ))}
                                  </div>
                              </div>
                          )}
                      </div>
                  </div>

                  {/* NEW: Sticky Mobile Buy Bar (Visible only on mobile) */}
                  <div className={`md:hidden fixed bottom-0 left-0 w-full z-[60] p-3 border-t shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] flex gap-2 ${isPrive ? 'bg-navy-950 border-navy-800' : 'bg-white border-gray-200'}`}>
                      <button
                          onClick={() => { onAddToCart({ ...product, selectedSize }); }}
                          disabled={isOutOfStock}
                          className={`flex-1 py-3 rounded font-bold uppercase text-xs tracking-wider ${isOutOfStock ? 'bg-gray-300 text-gray-500' : (isPrive ? 'bg-navy-800 text-white border border-gold-600' : 'bg-white text-navy-900 border border-navy-900')}`}
                      >
                          {isOutOfStock ? 'Sold Out' : 'Add to Cart'}
                      </button>
                      {!isOutOfStock && <button onClick={() => onBuyNow({ ...product, selectedSize })} className={`flex-1 py-3 rounded font-bold uppercase text-xs tracking-wider ${isPrive ? 'bg-gold-600 text-black' : 'bg-navy-900 text-white'}`}>Buy Now</button>}
                  </div>
              </div>
              {/* Full Screen Image Modal */}
              <FullScreenImageModal
                  isOpen={isFullScreenImageOpen}
                  onClose={() => setIsFullScreenImageOpen(false)}
                  onNext={goToNextImage}
                  onPrev={goToPrevImage}
                  hasNext={images.length > 1}
                  hasPrev={images.length > 1}
                  images={images}
                  activeImg={activeImg}
              />
          </>
      );
  };

  const HeroCarousel = ({ slides, isPrive, onScrollToCollection }) => {
      const [currentSlide, setCurrentSlide] = useState(0);
      useEffect(() => { const timer = setInterval(() => { setCurrentSlide((prev) => (prev + 1) % slides.length); }, 5000); return () => clearInterval(timer); }, [slides.length]);
      return ( <div className={`relative overflow-hidden ${isPrive ? 'bg-navy-950' : 'bg-[#FDFBF7]'}`}> <div className="relative h-[65vh] sm:h-screen w-full"> {slides.map((slide, index) => ( <div key={index} className={`absolute inset-0 transition-opacity duration-1000 ease-in-out ${index === currentSlide ? 'opacity-100 z-10' : 'opacity-0 z-0'}`}> <img src={slide} className={`w-full h-full object-cover object-top ${index === currentSlide ? 'animate-slow-zoom' : ''}`} alt="Hero Slide" /> <div className={`absolute inset-0 ${isPrive ? 'vignette-overlay bg-black/40' : 'bg-gradient-to-r from-white/30 to-transparent mix-blend-overlay'}`}></div> </div> ))} </div> <div className="absolute bottom-6 left-0 right-0 flex justify-center gap-3 z-30"> {slides.map((_, index) => ( <button key={index} onClick={() => setCurrentSlide(index)} className={`w-2 h-2 rounded-full transition-all ${index === currentSlide ? (isPrive ? 'bg-gold-500 w-6' : 'bg-navy-900 w-6') : (isPrive ? 'bg-gray-600' : 'bg-gray-400')}`} /> ))} </div> </div> );
  };

  const CategoryFilter = ({ categories, selectedCategory, onSelectCategory, isPrive }) => ( <div className="hidden md:flex flex-wrap gap-2 justify-center md:justify-start mb-8"> {categories.map(cat => ( <button key={cat} onClick={() => onSelectCategory(cat)} className={`px-5 py-2 rounded-full text-xs font-bold uppercase tracking-wider transition-all border ${selectedCategory === cat ? (isPrive ? 'bg-gold-600 text-black border-gold-600' : 'bg-navy-900 text-white border-navy-900') : (isPrive ? 'bg-navy-900 text-gray-400 border-navy-800 hover:border-gold-600' : 'bg-white text-gray-600 border-gray-200 hover:border-gold-600')}`}> {cat} </button> ))} </div> );

  const ProductCard = ({ product, onOpen, isPrive, onToggleWishlist, isWishlisted }) => {
      const stockVal = product.stock !== undefined ? product.stock : (product.quantity !== undefined ? product.quantity : 0);
      const isOutOfStock = Number(stockVal) <= 0;
      const isTrending = product.finalPrice > 3500;

      const handleMouseEnter = () => {
          if (product.images && product.images.length > 0) {
              product.images.forEach(src => { const img = new Image(); img.src = src; });
          }
      };

      return (
          <div className={`group relative rounded-xl overflow-hidden hover:shadow-2xl transition-all duration-500 flex flex-col h-full cursor-pointer border ${isPrive ? 'bg-navy-900 border-navy-800 hover:border-gold-600' : 'bg-white border-transparent hover:border-gray-100'}`} onClick={() => onOpen(product)} onMouseEnter={handleMouseEnter}>
              <div className="aspect-[3/4] bg-gray-100 relative overflow-hidden">
                  <img src={product.images && product.images.length > 0 ? product.images[0] : "https://placehold.co/400"} alt={product.title} className="w-full h-full object-contain transition-transform duration-700 group-hover:scale-105" loading="lazy" />
                  {product.discountPercent > 0 && !isOutOfStock && ( <span className="absolute top-3 left-3 bg-white/90 backdrop-blur text-red-700 text-[10px] font-bold px-2 py-1 rounded shadow-sm uppercase tracking-wider">{product.discountPercent}% OFF</span> )}
                  {isOutOfStock && ( <div className="absolute inset-0 bg-white/60 backdrop-blur-[1px] flex items-center justify-center z-10"><span className="bg-navy-900 text-white text-xs font-bold px-4 py-2 uppercase tracking-widest shadow-md border border-navy-800">Sold Out</span></div> )}
                  <button onClick={(e) => { e.stopPropagation(); onToggleWishlist(product); }} className={`absolute top-3 right-3 p-2 rounded-full shadow-md transition-transform hover:scale-110 z-20 ${isPrive ? 'bg-navy-950/80 text-gold-500' : 'bg-white/90 text-gray-400 hover:text-red-500'}`}><IconHeart filled={isWishlisted} /></button>
                  {/* EID BADGE */}
                  {!isOutOfStock && <div className="absolute bottom-0 left-0 w-full bg-emerald-900/90 text-white text-[10px] font-bold text-center py-1 tracking-widest">ðŸŒ™ Get it before Eid</div>}
                  {!isOutOfStock && (isTrending && <div className="absolute bottom-3 left-3 flex gap-1"><span className="bg-gradient-to-r from-amber-400 to-amber-600 text-white text-[10px] font-bold px-2 py-1 rounded shadow uppercase tracking-wider">Trending</span></div>)}
              </div>
              <div className="p-4 flex flex-col flex-grow text-center">
                  <p className={`text-xs uppercase tracking-wider font-semibold mb-1 ${isPrive ? 'text-gold-500' : 'text-gold-600'}`}>{product.category || 'Exclusive'}</p>
                  <h3 className={`text-base font-serif font-bold line-clamp-1 transition-colors ${isPrive ? 'text-white group-hover:text-gold-400' : 'text-gray-900 group-hover:text-gold-600'}`}>{product.title}</h3>
                  <div className="mt-2 flex items-center justify-center gap-2">
                      <span className={`text-lg font-bold ${isPrive ? 'text-white' : 'text-gray-900'}`}>{formatCurrency(product.finalPrice)}</span>
                      {product.mrp > product.finalPrice && ( <span className="text-xs text-gray-400 line-through">{formatCurrency(product.mrp)}</span> )}
                  </div>
              </div>
          </div>
      );
  };

  const CharityBanner = ({ isPrive }) => {
      return (
          <div className={`w-full py-12 px-4 mb-8 ${isPrive ? 'bg-navy-900 border-y border-gold-600/30' : 'bg-emerald-50 border-y border-emerald-100'}`}>
              <div className="max-w-3xl mx-auto text-center">
                  <div className="inline-block p-3 rounded-full mb-4 bg-white/10 backdrop-blur">
                      <span className="text-3xl">ðŸ¤²</span>
                  </div>
                  <h3 className={`text-2xl md:text-3xl font-serif font-bold mb-4 ${isPrive ? 'text-gold-500' : 'text-emerald-900'}`}>The Ethniq Ramadan Promise</h3>
                  <p className={`text-base leading-relaxed max-w-2xl mx-auto ${isPrive ? 'text-gray-300' : 'text-emerald-800'}`}>
                      "The best charity is that given in Ramadan." <br/>
                      In the spirit of this holy month, we are pledging <span className="font-bold border-b-2 border-gold-500">10% of our total profits</span> from every order as <span className="italic font-bold">Sadaqah</span> to support those in need.
                  </p>
                  <div className={`mt-6 text-xs font-bold uppercase tracking-widest opacity-70 ${isPrive ? 'text-gold-600' : 'text-emerald-700'}`}>
                      Shop for a Cause â€¢ Spread the Joy
                  </div>
              </div>
          </div>
      );
  };

  const ReviewsSection = ({ reviews, appMode, onWriteReview }) => { const isPrive = appMode === 'prive'; return ( <div className={`py-16 px-4 ${isPrive ? 'bg-navy-950 text-white' : 'bg-white text-gray-800'}`}> <div className="max-w-7xl mx-auto"> <div className="text-center mb-12"> <h2 className={`text-3xl font-serif font-bold mb-2 ${isPrive ? 'text-gold-500' : 'text-gray-900'}`}>Client Love</h2> <div className="w-16 h-1 bg-gold-600 mx-auto mb-4"></div> <p className={`text-sm mb-6 ${isPrive ? 'text-gray-400' : 'text-gray-500'}`}>What our customers are saying about us</p> <button onClick={onWriteReview} className={`px-6 py-2 text-xs font-bold uppercase tracking-widest border rounded hover:opacity-80 ${isPrive ? 'border-gold-500 text-gold-500' : 'border-navy-900 text-navy-900'}`}>Write a Review</button> </div> {reviews.length === 0 ? (<div className="text-center text-gray-500 italic">Be the first to write a review!</div>) : ( <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"> {reviews.map((review, idx) => { const reviewImages = review.images || (review.image ? [review.image] : []); return ( <div key={idx} className={`p-6 rounded-xl border relative h-full flex flex-col ${isPrive ? 'bg-navy-900 border-navy-800' : 'bg-gray-50 border-gray-100'}`}> <div className="flex items-center gap-1 mb-3">{[...Array(5)].map((_, i) => (<IconStar key={i} filled={i < (review.rating || 5)} />))}</div> <h3 className={`font-bold text-sm mb-1 ${isPrive ? 'text-white' : 'text-gray-900'}`}>{review.title || 'Customer Review'}</h3> <p className={`text-xs mb-4 ${isPrive ? 'text-gray-500' : 'text-gray-400'}`}>{review.date || 'Recently'}</p> <p className={`text-sm leading-relaxed italic mb-4 flex-grow ${isPrive ? 'text-gray-300' : 'text-gray-600'}`}>"{review.text}"</p> {reviewImages.length > 0 && ( <div className={`mt-4 grid gap-2 ${reviewImages.length === 1 ? 'grid-cols-1' : reviewImages.length === 2 ? 'grid-cols-2' : 'grid-cols-3'}`}> {reviewImages.slice(0, 3).map((imgUrl, imgIdx) => ( <div key={imgIdx} className="rounded-lg overflow-hidden bg-gray-100 aspect-square"> <img src={imgUrl} alt="Review" className="w-full h-full object-cover" /> </div> ))} </div> )} </div> )})} </div> )} </div> </div> ); };

const BrandStory = ({ appMode }) => {
  const isPrive = appMode === 'prive';
  const textColor = isPrive ? 'text-gray-300' : 'text-gray-600';
  const headingColor = isPrive ? 'text-gold-500' : 'text-navy-900';
  const cardBg = isPrive ? 'bg-navy-900 border-navy-800' : 'bg-white border-gray-100';

  return (
      <div className={`py-20 px-4 relative overflow-hidden ${isPrive ? 'bg-navy-950 text-white' : 'bg-gray-50 text-gray-900'}`}>
          <div className="absolute inset-0 opacity-5 pointer-events-none bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
          <div className="max-w-7xl mx-auto relative z-10">
              <div className="text-center max-w-3xl mx-auto mb-16">
                  <img src={isPrive ? PRIVE_LOGO_URL : REGULAR_LOGO_URL} className="h-20 w-auto mx-auto mb-6 rounded shadow-sm" alt="Logo" />
                  <h2 className={`text-4xl md:text-5xl font-serif font-bold mb-6 ${headingColor}`}>The Ethniq Promise</h2>
                  <p className={`text-lg leading-relaxed ${textColor}`}> At Ethniq Attire, we don't just sell clothes; we curate <span className="font-bold">heirlooms</span>. In a world of fast fashion, we stand for <span className="italic">timeless elegance</span>, uncompromised quality, and the trust of thousands of happy customers. </p>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16">
                  <div className={`p-8 rounded-xl border shadow-lg hover:-translate-y-2 transition-transform duration-300 ${cardBg}`}>
                      <div className={`w-14 h-14 rounded-full flex items-center justify-center mb-6 text-2xl ${isPrive ? 'bg-navy-800 text-gold-500' : 'bg-blue-50 text-navy-900'}`}>ðŸ’Ž</div>
                      <h3 className={`text-xl font-serif font-bold mb-3 ${isPrive ? 'text-white' : 'text-gray-900'}`}>Uncompromised Quality</h3>
                      <p className={`text-sm leading-relaxed ${textColor}`}> Why invest in Ethniq? Because we refuse to use cheap synthetics. Every fabric is handpicked for its <strong>texture, durability, and sheen</strong>. When you wear Ethniq, you wear luxury that lasts. </p>
                  </div>
                  <div className={`p-8 rounded-xl border shadow-lg hover:-translate-y-2 transition-transform duration-300 ${cardBg}`}>
                      <div className={`w-14 h-14 rounded-full flex items-center justify-center mb-6 text-2xl ${isPrive ? 'bg-navy-800 text-gold-500' : 'bg-blue-50 text-navy-900'}`}>âœ¨</div>
                      <h3 className={`text-xl font-serif font-bold mb-3 ${isPrive ? 'text-white' : 'text-gray-900'}`}>Handpicked Designs</h3>
                      <p className={`text-sm leading-relaxed ${textColor}`}> We carefully curate our collection to bring you the most elegant and trending styles. Every piece is <strong>handpicked</strong> for its beauty and quality, ensuring you look your best for every occasion. </p>
                  </div>
                  <div className={`p-8 rounded-xl border shadow-lg hover:-translate-y-2 transition-transform duration-300 ${cardBg}`}>
                      <div className={`w-14 h-14 rounded-full flex items-center justify-center mb-6 text-2xl ${isPrive ? 'bg-navy-800 text-gold-500' : 'bg-blue-50 text-navy-900'}`}>ðŸ¤</div>
                      <h3 className={`text-xl font-serif font-bold mb-3 ${isPrive ? 'text-white' : 'text-gray-900'}`}>Trusted & Verified</h3>
                      <p className={`text-sm leading-relaxed ${textColor}`}> We are a <strong>Government of India registered MSME</strong>. With secure payment gateways, transparent policies, and real human support, your trust is our most valuable asset. </p>
                  </div>
              </div>
              <div className={`flex flex-wrap justify-center gap-4 md:gap-8 border-t pt-12 ${isPrive ? 'border-navy-800' : 'border-gray-200'}`}>
                  <div className="flex items-center gap-2 px-4 py-2 rounded-full border border-gray-500/30 opacity-70"> <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> <span className="text-xs font-bold uppercase tracking-widest">100% Authentic</span> </div>
                  <div className="flex items-center gap-2 px-4 py-2 rounded-full border border-gray-500/30 opacity-70"> <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> <span className="text-xs font-bold uppercase tracking-widest">Secure Payments</span> </div>
                  <div className="flex items-center gap-2 px-4 py-2 rounded-full border border-gray-500/30 opacity-70"> <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg> <span className="text-xs font-bold uppercase tracking-widest">MSME Registered</span> </div>
              </div>
          </div>
      </div>
  );
};

  const ContactSection = ({ instaLink, appMode }) => { const isPrive = appMode === 'prive'; return ( <div id="contact-section" className={`py-16 border-b border-gray-200 transition-colors duration-500 ${isPrive ? 'bg-navy-950 text-white border-navy-900' : 'bg-gray-50 text-gray-800'}`}> <div className="max-w-7xl mx-auto px-4"> <div className="grid grid-cols-1 md:grid-cols-2 gap-12 items-center"> <div className="text-center md:text-left"> <h3 className={`text-2xl font-serif font-bold mb-4 ${isPrive ? 'text-gold-500' : 'text-gray-900'}`}>Connect With Us</h3> <p className={`mb-8 ${isPrive ? 'text-gray-400' : 'text-gray-600'}`}>Follow our journey and stay updated with the latest trends.</p> <div className="flex justify-center md:justify-start gap-6"> <a href={WHATSAPP_LINK} target="_blank" className={`w-16 h-16 rounded-full flex items-center justify-center transition transform hover:-translate-y-1 shadow-lg ${isPrive ? 'bg-transparent border border-gold-500 text-gold-500 hover:bg-gold-500 hover:text-navy-900' : 'bg-green-500 text-white hover:bg-green-600'}`}><IconWhatsapp /></a> <a href={instaLink} target="_blank" className={`w-16 h-16 rounded-full flex items-center justify-center transition transform hover:-translate-y-1 shadow-lg ${isPrive ? 'bg-transparent border border-gold-500 text-gold-500 hover:bg-gold-500 hover:text-navy-900' : 'bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500 text-white hover:opacity-90'}`}><IconInsta /></a> <a href={FB_LINK} target="_blank" className={`w-16 h-16 rounded-full flex items-center justify-center transition transform hover:-translate-y-1 shadow-lg ${isPrive ? 'bg-transparent border border-gold-500 text-gold-500 hover:bg-gold-500 hover:text-navy-900' : 'bg-blue-600 text-white hover:bg-blue-700'}`}><IconFB /></a> </div> </div> <div className={`p-8 rounded-xl shadow-sm border transition-colors duration-500 ${isPrive ? 'bg-navy-900 border-gold-600/30' : 'bg-white border-gray-100'}`}> <h3 className={`text-xl font-serif font-bold mb-6 border-b pb-2 ${isPrive ? 'text-white border-navy-800' : 'text-gray-900 border-gray-100'}`}>Contact Us</h3> <div className="space-y-4 text-sm"> <div className="flex items-start gap-3"><div className={`${isPrive ? 'text-gold-500' : 'text-gold-600'} mt-1`}><IconPhone /></div><div><span className={`block font-bold ${isPrive ? 'text-gray-200' : 'text-gray-900'}`}>Call Us</span><span className={`${isPrive ? 'text-gray-400' : 'text-gray-600'}`}>{PHONE_NUMBER}</span></div></div> <div className="flex items-start gap-3"><div className={`${isPrive ? 'text-gold-500' : 'text-green-600'} mt-1`}><IconWhatsapp /></div><div><span className={`block font-bold ${isPrive ? 'text-gray-200' : 'text-gray-900'}`}>WhatsApp Support</span><span className={`${isPrive ? 'text-gray-400' : 'text-gray-600'}`}>{PHONE_NUMBER}</span></div></div> <div className="flex items-start gap-3"><div className={`${isPrive ? 'text-gold-500' : 'text-blue-500'} mt-1`}><IconClock /></div><div><span className={`block font-bold ${isPrive ? 'text-gray-200' : 'text-gray-900'}`}>Support Time</span><span className={`${isPrive ? 'text-gray-400' : 'text-gray-600'}`}>24/7 Customer Support</span></div></div> <div className="flex items-start gap-3"><div className={`${isPrive ? 'text-gold-500' : 'text-gray-500'} mt-1`}><IconMail /></div><div><span className={`block font-bold ${isPrive ? 'text-gray-200' : 'text-gray-900'}`}>Email</span><span className={`${isPrive ? 'text-gray-400' : 'text-gray-600'}`}>{EMAIL_ID}</span></div></div> <div className="flex items-start gap-3"><div className={`${isPrive ? 'text-gold-500' : 'text-red-500'} mt-1`}><IconMap /></div><div><span className={`block font-bold ${isPrive ? 'text-gray-200' : 'text-gray-900'}`}>Address</span><span className={`${isPrive ? 'text-gray-400' : 'text-gray-600'}`}>{ADDRESS}</span></div></div> </div> </div> </div> </div> </div> ); };

  const CollectionView = ({ category, products, onOpenProduct, onToggleWishlist, wishlist, onBack, isPrive }) => {
      return ( <div className={`min-h-screen pt-4 pb-20 ${isPrive ? 'bg-navy-950 text-white' : 'bg-white text-gray-900'}`}> <div className="max-w-7xl mx-auto px-4"> <div className="flex items-center mb-8"> <button onClick={onBack} className={`mr-4 p-2 rounded-full ${isPrive ? 'bg-navy-800 text-gold-500' : 'bg-gray-100 text-gray-800'}`}> <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg> </button> <div> <p className={`text-[10px] uppercase tracking-widest font-bold ${isPrive ? 'text-gold-500' : 'text-gold-600'}`}>Collection</p> <h1 className="text-2xl font-serif font-bold">{category}</h1> </div> </div> {products.length === 0 ? ( <div className="text-center py-20 opacity-50">No products found in this category.</div> ) : ( <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6 lg:gap-8"> {products.map(product => ( <ProductCard key={product.id} product={product} onOpen={onOpenProduct} isPrive={isPrive} onToggleWishlist={onToggleWishlist} isWishlisted={wishlist.some(w => w.id === product.id)} /> ))} </div> )} </div> </div> );
  };

  const CartView = ({ cart, onUpdateQty, onRemove, onCheckout, appMode, onViewChange, onOpenProduct, user, userData }) => {
      const isPrive = appMode === 'prive';
      // Eidi Logic: Check localStorage for saved code
      const [promoCode, setPromoCode] = useState('');
      const [activePromo, setActivePromo] = useState(null);
      const [promoError, setPromoError] = useState('');
      const [isGiftWrapped, setIsGiftWrapped] = useState(false);
      const [giftMessage, setGiftMessage] = useState('');
      const [savedCoupons, setSavedCoupons] = useState([]);

      const subtotal = cart.reduce((acc, item) => acc + (item.finalPrice * item.quantity), 0);
      const totalItems = cart.reduce((acc, item) => acc + item.quantity, 0);

      let discount = 0;
      if (activePromo) {
          if (activePromo.type === 'percentage') { discount = (subtotal * activePromo.value) / 100; }
          else { discount = Number(activePromo.value); }
          if (discount > subtotal) discount = subtotal;
      }
      const giftWrapCost = isGiftWrapped ? (totalItems * 100) : 0;

      const total = subtotal - discount + giftWrapCost;

      // Load Available Coupons (Eidi & Zara)
      useEffect(() => {
          const coupons = [];
          // 1. Eidi Reward
          let eidiData = userData?.eidiReward;
          if (!eidiData) {
              const savedEidi = localStorage.getItem('ethniq_eidi_reward');
              if (savedEidi) eidiData = JSON.parse(savedEidi);
          }

          if (eidiData && !eidiData.used) {
              const { code, discountPercent, timestamp } = eidiData;
              const now = Date.now();
              const isValid = !timestamp || (now - timestamp < 30 * 24 * 60 * 60 * 1000);
              if (isValid) {
                  coupons.push({ code, desc: `Eid Gift (${discountPercent}% Off)`, type: 'eidi' });
              }
          }

          // 2. Zara AI Reward
          let zaraData = userData?.zaraReward;
          if (!zaraData && user) {
               const localZara = localStorage.getItem(`zara_code_given_${user.uid}`);
               if (localZara) zaraData = { code: localZara === 'true' ? 'LOVE15' : localZara };
          }

          if (zaraData && !zaraData.used) {
              coupons.push({ code: zaraData.code, desc: "Zara's Special Gift (15% Off)", type: 'zara' });
          }
          setSavedCoupons(coupons);
      }, [user, userData]);

      const handleApplyPromo = async () => {
          if (!promoCode.trim()) return;
          setPromoError(''); setActivePromo(null);
          try {
              const promosRef = db.collection('artifacts').doc(APP_ID).collection('users').doc(MERCHANT_ID).collection('promocodes');
              const snapshot = await promosRef.where('code', '==', promoCode.toUpperCase()).where('isActive', '==', true).get();
              if (snapshot.empty) { setPromoError('Invalid or expired code.'); }
              else {
                  const promo = snapshot.docs[0].data();
                  setActivePromo(promo);
              }
          } catch (e) { console.error("Promo check failed", e); setPromoError("Could not verify code."); }
      };

      // Special handler for Eidi codes which might not be in DB but generated client-side for this game
      const handleApplyEidi = () => {
          try {
              let eidiData = userData?.eidiReward;
              if (!eidiData) {
                  const savedEidi = localStorage.getItem('ethniq_eidi_reward');
                  if (savedEidi) eidiData = JSON.parse(savedEidi);
              }

              if (eidiData) {
                  const { code, discountPercent, timestamp } = eidiData;

                  // Expiry Check inside Apply function too
                  if (timestamp && (Date.now() - timestamp > 30 * 24 * 60 * 60 * 1000)) {
                      setPromoError("This Eidi code has expired.");
                      return;
                  }

                  if (promoCode.toUpperCase() === code) {
                      // Mock a promo object for the client-side generated code
                      const promo = { code: code, type: 'percentage', value: discountPercent, isActive: true };
                      setActivePromo(promo);
                  }
              }
          } catch (e) { console.error("Promo check failed", e); setPromoError("Could not verify code."); }
      };

      const handleWhatsAppCartOrder = () => {
          let msg = `*Hi Ethniq Team! I want to order these items:* ðŸ›ï¸\n\n`;
          cart.forEach((item, i) => {
              msg += `${i+1}. ${item.title} (Size: ${item.selectedSize || 'N/A'}) - ${formatCurrency(item.finalPrice)}\n`;
          });
          msg += `\n*Total Estimate:* ${formatCurrency(total)}\n`;
          if(activePromo) msg += `(Promo Code ${activePromo.code} applied)\n`;
          msg += `\n----------------------------\n`;
          msg += `Please confirm availability and payment details.`;

          const encodedMsg = encodeURIComponent(msg);
          window.open(`https://wa.me/${PHONE_NUMBER.replace(/\D/g, '')}?text=${encodedMsg}`, '_blank');
      };

      const bgClass = isPrive ? 'bg-navy-900 text-white' : 'bg-white text-gray-900';
      const cardBgClass = isPrive ? 'bg-navy-800 border-navy-700' : 'bg-white border-gray-100';
      const textMainClass = isPrive ? 'text-white' : 'text-gray-900';
      const textSubClass = isPrive ? 'text-gray-400' : 'text-gray-500';
      const buttonClass = isPrive ? 'border border-gold-600 text-gold-500 hover:bg-gold-600 hover:text-white' : 'bg-navy-900 text-white hover:bg-gray-800';

      if(cart.length === 0) return ( <div className={`min-h-[60vh] flex flex-col items-center justify-center text-center px-4 ${isPrive ? 'bg-navy-950 text-white' : 'bg-white text-gray-900'}`}> <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-6 ${isPrive ? 'bg-navy-800 text-gold-500' : 'bg-gray-100 text-gray-600'}`}><IconBag /></div> <h2 className={`text-2xl font-serif font-bold mb-2 ${textMainClass}`}>Your Cart is Empty</h2> <p className={`${textSubClass} mb-8`}>Explore our latest collection to add items.</p> <button onClick={() => onViewChange('home')} className={`px-8 py-3 rounded transition uppercase tracking-widest text-xs font-bold ${buttonClass}`}>Start Shopping</button> </div> );

      return (
          <div className={`min-h-screen ${isPrive ? 'bg-navy-950' : 'bg-white'}`}>
              <div className="max-w-4xl mx-auto px-4 py-12">
                  <h1 className={`text-3xl font-serif font-bold mb-8 border-b pb-4 ${isPrive ? 'border-navy-800 text-white' : 'border-gray-200 text-gray-900'}`}>Your Shopping Bag</h1>
                  <div className="space-y-6"> {cart.map((item, idx) => ( <div key={`${item.id}-${idx}`} className={`flex gap-6 p-4 rounded-lg shadow-sm border ${cardBgClass}`}> <img src={item.images[0] || "https://placehold.co/100"} className="w-24 h-32 object-cover rounded-md cursor-pointer hover:opacity-80" onClick={() => onOpenProduct(item)} /> <div className="flex-grow flex flex-col justify-between"> <div> <h3 className={`font-bold text-lg cursor-pointer hover:underline ${textMainClass}`} onClick={() => onOpenProduct(item)}>{item.title}</h3> <p className={`text-sm ${textSubClass}`}>Size: {item.selectedSize || 'Standard'}</p> <p className="text-gold-600 font-bold mt-1">{formatCurrency(item.finalPrice)}</p> </div> <div className="flex items-center justify-between mt-2"> <div className={`flex items-center border rounded ${isPrive ? 'border-navy-700 bg-navy-900 text-white' : 'border-gray-300 bg-gray-50 text-gray-900'}`}> <button onClick={() => onUpdateQty(idx, -1)} className="px-3 py-1 hover:opacity-70">-</button> <span className="px-2 font-medium text-sm">{item.quantity}</span> <button onClick={() => onUpdateQty(idx, 1)} className="px-3 py-1 hover:opacity-70">+</button> </div> <button onClick={() => onRemove(idx)} className="text-sm text-red-500 hover:text-red-700 font-medium">Remove</button> </div> </div> </div> ))} </div>

                  <div className="mt-8">
                      {/* AVAILABLE COUPONS SECTION */}
                      {savedCoupons.length > 0 && (
                          <div className="mb-6">
                              <label className={`block text-xs font-bold uppercase tracking-wider mb-2 ${textMainClass}`}>Your Available Offers</label>
                              <div className="space-y-2">
                                  {savedCoupons.map((coupon, idx) => (
                                      <div key={idx} onClick={() => setPromoCode(coupon.code)} className={`p-3 border border-dashed rounded cursor-pointer flex justify-between items-center transition hover:bg-opacity-50 group ${isPrive ? 'border-gold-600 bg-navy-800 hover:bg-navy-700' : 'border-green-500 bg-green-50 hover:bg-green-100'}`}>
                                          <div>
                                              <p className={`font-bold text-sm ${isPrive ? 'text-gold-500' : 'text-green-700'}`}>{coupon.code}</p>
                                              <p className={`text-xs ${isPrive ? 'text-gray-400' : 'text-gray-600'}`}>{coupon.desc}</p>
                                          </div>
                                          <button className={`text-[10px] font-bold px-3 py-1 rounded uppercase tracking-wider ${isPrive ? 'bg-gold-600 text-black group-hover:bg-gold-500' : 'bg-green-600 text-white group-hover:bg-green-700'}`}>Apply</button>
                                      </div>
                                  ))}
                              </div>
                          </div>
                      )}

                      <label className={`block text-xs font-bold uppercase tracking-wider mb-2 ${textMainClass}`}>Have a Promo Code?</label>
                      <div className="flex gap-2">
                          <input type="text" value={promoCode} onChange={(e) => setPromoCode(e.target.value)} placeholder="Enter code" className={`flex-1 p-3 rounded border outline-none ${isPrive ? 'bg-navy-900 border-navy-700 text-white' : 'bg-gray-50 border-gray-300'}`} />
                          <button onClick={() => { if(promoCode.startsWith('EIDI')) handleApplyEidi(); else handleApplyPromo(); }} className={`px-6 rounded font-bold text-sm ${isPrive ? 'bg-gold-600 text-black' : 'bg-navy-900 text-white'}`}>APPLY</button>
                      </div>
                      {promoError && <p className="text-red-500 text-xs mt-1">{promoError}</p>}
                      {activePromo && <p className="text-green-500 text-xs mt-1">Code applied! You saved {formatCurrency(discount)}</p>}
                  </div>

                  {/* GIFT WRAP OPTION */}
                  <div className={`mt-6 p-4 rounded border ${isPrive ? 'bg-navy-800 border-navy-700' : 'bg-pink-50 border-pink-100'}`}>
                      <div className="flex items-center justify-between">
                          <div className="flex items-center gap-3">
                              <div className={`p-2 rounded-full ${isPrive ? 'bg-navy-900 text-gold-500' : 'bg-white text-pink-500'}`}><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg></div>
                              <div>
                                  <p className={`text-sm font-bold ${textMainClass}`}>Gift Wrap this order?</p>
                                  <p className={`text-xs ${textSubClass}`}>Add a special touch for just â‚¹100 per item</p>
                              </div>
                          </div>
                          <input type="checkbox" checked={isGiftWrapped} onChange={() => setIsGiftWrapped(!isGiftWrapped)} className="w-5 h-5 accent-pink-500 cursor-pointer" />
                      </div>
                      {isGiftWrapped && (
                          <div className="mt-4 animate-fade-in">
                              <label className={`block text-xs font-bold uppercase tracking-wider mb-2 ${textMainClass}`}>Gift Message (Optional)</label>
                              <textarea
                                  value={giftMessage}
                                  onChange={(e) => setGiftMessage(e.target.value)}
                                  placeholder="Write a message for the recipient..."
                                  className={`w-full p-3 rounded border outline-none text-sm ${isPrive ? 'bg-navy-900 border-navy-700 text-white placeholder-gray-500' : 'bg-white border-pink-200 text-gray-800 placeholder-gray-400'}`}
                                  rows="2"
                              />
                          </div>
                      )}
                  </div>

                  <div className={`mt-8 border-t pt-6 space-y-2 ${isPrive ? 'border-navy-800' : 'border-gray-200'}`}>
                      <div className={`flex justify-between text-sm ${textSubClass}`}><span>Subtotal</span> <span>{formatCurrency(subtotal)}</span></div>
                      {discount > 0 && <div className="flex justify-between text-sm text-green-500 font-bold"><span>Discount</span> <span>- {formatCurrency(discount)}</span></div>}
                      {isGiftWrapped && <div className="flex justify-between text-sm text-pink-500 font-bold"><span>Gift Wrap</span> <span>+ {formatCurrency(giftWrapCost)}</span></div>}
                      <div className={`flex justify-between text-xl font-serif font-bold mb-6 pt-2 border-t ${isPrive ? 'border-navy-800' : 'border-gray-100'} ${textMainClass}`}><span>Total</span> <span>{formatCurrency(total)}</span></div>
                      <button onClick={() => onCheckout({total, discount, promoCode: activePromo ? activePromo.code : '', isGiftWrapped, giftMessage})} className={`w-full py-4 rounded text-lg font-bold transition shadow-md ${isPrive ? 'bg-gold-600 text-white hover:bg-gold-700' : 'bg-navy-900 text-white hover:bg-gray-800'}`}>Proceed to Checkout</button>

                      <div className="mt-4 pt-4 border-t border-dashed border-gray-300/50 text-center">
                          <p className={`text-xs font-bold mb-2 ${textSubClass}`}>Or order directly via WhatsApp</p>
                          <button onClick={handleWhatsAppCartOrder} className="w-full py-3 rounded font-bold border-2 border-green-500 text-green-600 hover:bg-green-50 flex items-center justify-center gap-2 transition uppercase tracking-wider text-sm">
                              <IconWhatsapp /> Order via WhatsApp
                          </button>
                      </div>
                  </div>
              </div>
          </div>
      )
  };

  const WishlistView = ({ wishlist, onRemove, onAddToCart, appMode, onViewChange, onOpenProduct }) => {
      const isPrive = appMode === 'prive';
      const bgClass = isPrive ? 'bg-navy-900 text-white' : 'bg-white text-gray-900';
      const cardBgClass = isPrive ? 'bg-navy-800 border-navy-700' : 'bg-white border-gray-100';
      const textMainClass = isPrive ? 'text-white' : 'text-gray-900';
      const textSubClass = isPrive ? 'text-gray-400' : 'text-gray-500';
      const buttonClass = isPrive ? 'border border-gold-600 text-gold-500 hover:bg-gold-600 hover:text-white' : 'bg-navy-900 text-white hover:bg-gray-800';

      if(wishlist.length === 0) return ( <div className={`min-h-[60vh] flex flex-col items-center justify-center text-center px-4 ${isPrive ? 'bg-navy-950 text-white' : 'bg-white text-gray-900'}`}> <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-6 ${isPrive ? 'bg-navy-800 text-gold-500' : 'bg-gray-100 text-gray-400'}`}><IconHeart filled={true} /></div> <h2 className={`text-2xl font-serif font-bold mb-2 ${textMainClass}`}>Your Wishlist is Empty</h2> <p className={`${textSubClass} mb-8`}>Save items you love here.</p> <button onClick={() => onViewChange('home')} className={`px-8 py-3 rounded transition uppercase tracking-widest text-xs font-bold ${buttonClass}`}>Start Shopping</button> </div> );
      return (
          <div className={`min-h-screen ${isPrive ? 'bg-navy-950' : 'bg-white'}`}>
              <div className="max-w-4xl mx-auto px-4 py-12">
                  <h1 className={`text-3xl font-serif font-bold mb-8 border-b pb-4 ${isPrive ? 'border-navy-800 text-white' : 'border-gray-200 text-gray-900'}`}>Your Wishlist</h1>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                      {wishlist.map((item) => {
                          const stockVal = item.stock !== undefined ? item.stock : (item.quantity !== undefined ? item.quantity : 0);
                          const isOutOfStock = Number(stockVal) <= 0;
                          return (
                              <div key={item.id} className={`group relative rounded-xl overflow-hidden hover:shadow-2xl transition-all duration-500 flex flex-col border ${cardBgClass}`}>
                                  <div className="aspect-[3/4] bg-gray-100 relative overflow-hidden cursor-pointer" onClick={() => onOpenProduct(item)}>
                                      <img src={item.images && item.images.length > 0 ? item.images[0] : (item.image || "https://placehold.co/400")} alt={item.title} className="w-full h-full object-contain" />
                                      <button onClick={(e) => { e.stopPropagation(); onRemove(item.id); }} className="absolute top-2 right-2 p-1.5 bg-white/80 rounded-full text-red-500 hover:bg-white"><IconClose /></button>
                                  </div>
                                  <div className="p-4 flex flex-col flex-grow text-center">
                                      <h3 onClick={() => onOpenProduct(item)} className={`text-sm font-bold truncate cursor-pointer hover:underline ${textMainClass}`}>{item.title}</h3>
                                      <p className={`text-xs mt-1 ${textSubClass}`}>{formatCurrency(item.finalPrice)}</p>
                                      <button
                                          onClick={() => onAddToCart({...item, quantity: 1, selectedSize: item.sizes ? item.sizes.split(',')[0] : ''})}
                                          disabled={isOutOfStock}
                                          className={`mt-3 w-full py-2 text-xs font-bold uppercase rounded transition ${isOutOfStock ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : (isPrive ? 'bg-gold-600 text-black hover:bg-gold-500' : 'bg-navy-900 text-white hover:bg-navy-800')}`}
                                      >
                                          {isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                                      </button>
                                  </div>
                              </div>
                          );
                      })}
                  </div>
              </div>
          </div>
      );
  };

  // --- NEW FESTIVE COMPONENTS ---
  const FestiveDecorations = () => (
      <div className="fixed top-0 left-0 w-full pointer-events-none z-[55] overflow-hidden h-40">
          {/* Lanterns hanging from top */}
          <div className="absolute top-[-10px] left-[10%] animate-float" style={{animationDelay: '0s'}}>
              <div className="w-0.5 h-16 bg-gold-600 mx-auto"></div>
              <IconLantern className="w-12 h-12 text-gold-500 drop-shadow-lg" />
          </div>
          <div className="absolute top-[-20px] left-[85%] animate-float" style={{animationDelay: '1.5s'}}>
              <div className="w-0.5 h-12 bg-gold-600 mx-auto"></div>
              <IconLantern className="w-10 h-10 text-gold-500 drop-shadow-lg" />
          </div>
          <div className="absolute top-[-5px] left-[50%] animate-float hidden md:block" style={{animationDelay: '0.5s'}}>
              <div className="w-0.5 h-20 bg-gold-600 mx-auto"></div>
              <IconLantern className="w-14 h-14 text-gold-500 drop-shadow-lg" />
          </div>
      </div>
  );

  const RamadanModal = ({ isOpen, onClose }) => {
      if (!isOpen) return null;
      return (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
              <div className="fixed inset-0 bg-black/80 backdrop-blur-sm" onClick={onClose}></div>
              <div className="relative w-full max-w-sm p-8 rounded-2xl shadow-2xl text-center bg-navy-950 border border-gold-600 animate-pop-in">
                  <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white"><IconClose /></button>
                  <div className="mb-6 flex justify-center">
                      <IconLantern className="w-20 h-20 text-gold-500 animate-pulse" />
                  </div>
                  <h2 className="text-3xl font-serif font-bold text-gold-500 mb-2">Ramadan Mubarak</h2>
                  <p className="text-gray-300 mb-6 text-sm leading-relaxed">May this holy month bring peace, joy, and prosperity to you and your family. <br/><br/> Explore our exclusive Eid Collection now.</p>
                  <button onClick={onClose} className="w-full py-3 bg-gold-600 text-black font-bold rounded uppercase tracking-widest hover:bg-gold-500 transition">Shop Eid Collection</button>
              </div>
          </div>
      );
  };

  const EidiModal = ({ isOpen, onClose, onClaim }) => {
      const [selected, setSelected] = useState(null);
      const [reward, setReward] = useState(null);

      if (!isOpen) return null;

      const handleSelect = (index) => {
          if (selected !== null) return;
          setSelected(index);

          // UPDATED LOGIC: 10% (20%), 15% (70%), 25% (10%)
          const rand = Math.random();
          let discount = 10; // Minimum is now 10%
          if (rand > 0.9) discount = 25;      // 1 in 10 chance (Top Prize)
          else if (rand > 0.2) discount = 15; // Most people (70% chance)

          const code = `EIDI${discount}`; // EIDI5, EIDI15, EIDI25

          setTimeout(() => {
              setReward({ discount, code });
              onClaim({ discountPercent: discount, code });
          }, 600);
      };

      return (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
              <div className="fixed inset-0 bg-black/80 backdrop-blur-sm" onClick={onClose}></div>
              <div className="relative w-full max-w-md p-8 rounded-2xl shadow-2xl text-center bg-white border-4 border-gold-600 animate-pop-in overflow-hidden">
                  <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-600 via-gold-500 to-green-600"></div>

                  {!reward ? (
                      <>
                          <h2 className="text-2xl font-serif font-bold text-navy-900 mb-2">Claim Your Eidi! ðŸŽ</h2>
                          <p className="text-gray-600 mb-8 text-sm">Pick an envelope to reveal your special Eid discount.</p>
                          <div className="flex justify-center gap-4">
                              {[0, 1, 2].map(i => (
                                  <button
                                      key={i}
                                      onClick={() => handleSelect(i)}
                                      className={`w-24 h-32 bg-gradient-to-b from-green-600 to-green-800 rounded-lg shadow-lg flex items-center justify-center border-2 border-gold-500 transition-all duration-500 ${selected === i ? 'scale-110 rotate-y-180' : 'hover:-translate-y-2'} ${selected !== null && selected !== i ? 'opacity-50 grayscale' : ''}`}
                                  >
                                      <span className="text-4xl">âœ‰ï¸</span>
                                  </button>
                              ))}
                          </div>
                      </>
                  ) : (
                      <div className="animate-fade-in">
                          <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                              <span className="text-4xl">ðŸŽ‰</span>
                          </div>
                          <h2 className="text-3xl font-bold text-green-600 mb-2">{reward.discount}% OFF</h2>
                          <p className="text-gray-600 mb-4">Mubarak! You won {reward.discount}% discount.</p>
                          <div className="bg-gray-100 p-3 rounded border border-dashed border-gray-400 mb-6 font-mono font-bold text-lg tracking-widest">{reward.code}</div>
                          <button onClick={onClose} className="w-full py-3 bg-navy-900 text-white font-bold rounded uppercase tracking-widest hover:bg-navy-800 transition">Start Shopping</button>
                          <p className="text-[10px] text-gray-400 mt-2">Code auto-applied at checkout</p>
                      </div>
                  )}
              </div>
          </div>
      );
  };

  const RecentlyViewedSection = ({ products, onOpen, isPrive }) => {
      if (!products || products.length === 0) return null;
      return (
          <div className={`py-12 px-4 border-t ${isPrive ? 'bg-navy-950 border-navy-900' : 'bg-white border-gray-100'}`}>
              <div className="max-w-7xl mx-auto">
                  <h2 className={`text-2xl font-serif font-bold mb-6 ${isPrive ? 'text-gold-500' : 'text-gray-900'}`}>Recently Viewed</h2>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      {products.map(product => (
                          <div
                              key={product.id}
                              onClick={() => onOpen(product)}
                              className={`cursor-pointer group p-2 rounded border hover:shadow-lg transition ${isPrive ? 'bg-navy-900 border-navy-800 hover:border-gold-600' : 'bg-white border-gray-100'}`}
                          >
                              <div className={`aspect-[3/4] rounded overflow-hidden mb-2 relative ${isPrive ? 'bg-navy-950' : 'bg-gray-100'}`}>
                                  <img src={product.images && product.images[0] ? product.images[0] : "https://placehold.co/400"} className="w-full h-full object-cover transition duration-500 group-hover:scale-105" alt={product.title} />
                              </div>
                              <p className={`text-xs font-bold truncate ${isPrive ? 'text-white' : 'text-gray-800'}`}>{product.title}</p>
                              <p className={`text-xs ${isPrive ? 'text-gray-400' : 'text-gray-500'}`}>{formatCurrency(product.finalPrice)}</p>
                          </div>
                      ))}
                  </div>
              </div>
          </div>
      );
  };

  const FloatingWhatsApp = () => (
      <a href={WHATSAPP_LINK} target="_blank" className="fixed bottom-24 left-4 md:bottom-8 md:left-8 z-[90] w-12 h-12 md:w-14 md:h-14 bg-green-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-green-600 transition hover:scale-110 animate-bounce" style={{animationDuration: '3s'}}>
          <IconWhatsapp />
      </a>
  );

  // --- APP-LIKE FEATURES (Splash & Offline) ---
  const OfflinePage = () => (
      <div className="fixed inset-0 z-[200] flex flex-col items-center justify-center bg-white text-center p-6">
          <div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-6">
              <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
          </div>
          <h2 className="text-xl font-serif font-bold text-gray-900 mb-2">No Internet Connection</h2>
          <p className="text-gray-500 mb-6 text-sm">Please check your network settings and try again.</p>
          <button onClick={() => window.location.reload()} className="px-6 py-3 bg-navy-900 text-white font-bold rounded uppercase tracking-widest text-xs">Retry</button>
      </div>
  );

  const PullToRefresh = ({ onRefresh, children }) => {
      const [startY, setStartY] = useState(0);
      const [refreshing, setRefreshing] = useState(false);
      const [pullDistance, setPullDistance] = useState(0);

      const handleTouchStart = (e) => {
          if (window.scrollY === 0) {
              setStartY(e.touches[0].clientY);
          }
      };

      const handleTouchMove = (e) => {
          const currentY = e.touches[0].clientY;
          if (window.scrollY === 0 && currentY > startY) {
              // Resistance effect (0.4) to make it feel like a real app
              setPullDistance((currentY - startY) * 0.4);
          }
      };

      const handleTouchEnd = () => {
          if (pullDistance > 80) { // Threshold to trigger refresh
              setRefreshing(true);
              setPullDistance(0);
              onRefresh().then(() => setRefreshing(false));
          } else {
              setPullDistance(0);
          }
      };

      return (
          <div onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}>
              <div
                  className="fixed left-0 w-full flex justify-center z-[60] pointer-events-none transition-all duration-300"
                  style={{ top: refreshing ? '110px' : (pullDistance > 0 ? `${Math.min(pullDistance, 120) + 50}px` : '-60px'), opacity: (pullDistance > 0 || refreshing) ? 1 : 0 }}
              >
                  <div className="bg-white p-3 rounded-full shadow-xl border border-gray-100">
                      <svg className={`w-6 h-6 text-gold-600 ${refreshing ? 'animate-spin' : ''}`} style={{ transform: `rotate(${pullDistance * 3}deg)` }} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                      </svg>
                  </div>
              </div>
              {children}
          </div>
      );
  };

  function App() {
    const [isOnline, setIsOnline] = useState(navigator.onLine); // Offline State
    const [user, setUser] = useState(null);
    const [userData, setUserData] = useState({});
    const [products, setProducts] = useState([]);
    const [reviews, setReviews] = useState([]);
    const [loading, setLoading] = useState(true);
    const [appMode, setAppMode] = useState('regular');
    const [view, setView] = useState('home');
    const [isReviewModalOpen, setIsReviewModalOpen] = useState(false);
    const [showSuccessModal, setShowSuccessModal] = useState({show: false, title: '', msg: ''});
    const [isAuthModalOpen, setIsAuthModalOpen] = useState(false);
    const [notification, setNotification] = useState({ show: false, message: '' });
    const [isSearchModalOpen, setIsSearchModalOpen] = useState(false);
    const [isCategoryModalOpen, setIsCategoryModalOpen] = useState(false);
    const [cart, setCart] = useState([]);
    const [wishlist, setWishlist] = useState([]);
    const [selectedProduct, setSelectedProduct] = useState(null);
    const [selectedOrder, setSelectedOrder] = useState(null);
    // const [isFullScreenImageOpen, setIsFullScreenImageOpen] = useState(false); // Moved inside ProductModal
    const [isCheckoutOpen, setIsCheckoutOpen] = useState(false);
    const [checkoutData, setCheckoutData] = useState({ total: 0, discount: 0, promoCode: '' });
    const [searchQuery, setSearchQuery] = useState('');
    const [selectedCategory, setSelectedCategory] = useState('All');
    const [showAllProducts, setShowAllProducts] = useState(false);
    const [confirmation, setConfirmation] = useState({ isOpen: false, onConfirm: () => {} });
    const [ordersRefreshKey, setOrdersRefreshKey] = useState(0);
    const [sortBy, setSortBy] = useState('newest'); // Sorting State
    const [legalModal, setLegalModal] = useState({ isOpen: false, title: '', content: '' });
    const [showRamadanModal, setShowRamadanModal] = useState(false);
    const [showEidiModal, setShowEidiModal] = useState(false);
    const [recentlyViewed, setRecentlyViewed] = useState([]);

    // --- USER DATA FETCH/SAVE LOGIC ---
    // NEW: Sync function to ensure rewards persist across devices if claimed locally first
    const syncLocalRewards = async (currentUser, currentData) => {
        if (!currentUser) return;

        const localEidi = localStorage.getItem('ethniq_eidi_reward');
        const localZara = localStorage.getItem(`zara_code_given_${currentUser.uid}`);

        const updates = {};
        let hasUpdates = false;

        // Sync Eidi if not in DB but in Local
        if (localEidi && !currentData.eidiReward) {
            try { updates.eidiReward = JSON.parse(localEidi); hasUpdates = true; } catch(e) {}
        }

        // Sync Zara if not in DB but in Local
        if (localZara && !currentData.zaraReward) {
            updates.zaraReward = { code: localZara, timestamp: Date.now() };
            hasUpdates = true;
        }

        if (hasUpdates) {
            try {
                await userDocRef(currentUser.uid).set(updates, { merge: true });
                setUserData(prev => ({ ...prev, ...updates }));
            } catch (e) { console.error("Sync failed", e); }
        }
    };

    // --- APP INITIALIZATION EFFECT ---
    useEffect(() => {
        // Online/Offline Listeners
        const handleOnline = () => setIsOnline(true);
        const handleOffline = () => setIsOnline(false);
        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);

        return () => {
            window.removeEventListener('online', handleOnline);
            window.removeEventListener('offline', handleOffline);
        };
    }, []);

    const fetchUserData = async (currentUser) => {
        if (!currentUser) {
            setUserData({});
            return;
        }
        try {
            const doc = await userDocRef(currentUser.uid).get();
            let data = {};
            if (doc.exists) {
                data = doc.data();
            } else {
                // Initialize a basic document if it doesn't exist
                data = { email: currentUser.email, createdAt: new Date().toISOString() };
                await userDocRef(currentUser.uid).set(data, { merge: true });
            }
            setUserData(data);
            syncLocalRewards(currentUser, data); // Trigger sync after fetching
        } catch (error) {
            console.error("Error fetching user data:", error);
        }
    };

    const handleSaveProfile = async (data) => {
        if (!user) return;
        try {
            const dataToSave = {
                ...data,
                phoneNumber: data.phoneNumber || '', // The phone number is already formatted in ProfileView
                email: user.email
            };
            await userDocRef(user.uid).set(dataToSave, { merge: true });
            setUserData(prev => ({ ...prev, ...dataToSave })); // FIX: Merge with previous state to keep rewards
        } catch (error) {
            console.error("Error saving user data:", error);
            throw error;
        }
    };

    const handleLogout = async () => {
        try {
            await auth.signOut();
            setUser(null);
            setUserData({});
            setView('home');
            // FIX: Clear Eidi reward on logout so next user doesn't see previous user's reward
            localStorage.removeItem('ethniq_eidi_reward');
            showNotification('Logged out successfully');
        } catch (error) {
            console.error('Logout error:', error);
        }
    };

    // --- CORE EFFECTS ---
    useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged((u) => {
            setUser(u);
            if (u) {
                fetchUserData(u);
            } else {
                setUserData({});
            }
        });
        return () => unsubscribe();
    }, []);

    useEffect(() => { const savedCart = localStorage.getItem('ethniqCart'); if (savedCart) setCart(JSON.parse(savedCart)); const savedWishlist = localStorage.getItem('ethniqWishlist'); if (savedWishlist) setWishlist(JSON.parse(savedWishlist)); }, []);
    useEffect(() => { localStorage.setItem('ethniqCart', JSON.stringify(cart)); }, [cart]);
    useEffect(() => { localStorage.setItem('ethniqWishlist', JSON.stringify(wishlist)); }, [wishlist]);

    const showNotification = (msg) => { setNotification({ show: true, message: msg }); setTimeout(() => setNotification({ show: false, message: '' }), 3000); };

    const fetchData = async () => { try { const productSnapshot = await db.collectionGroup('catalog').get(); const productList = productSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); setProducts(productList); const reviewSnapshot = await db.collection('artifacts').doc(APP_ID).collection('users').doc(MERCHANT_ID).collection('reviews').orderBy('date', 'desc').get(); const reviewList = reviewSnapshot.docs.map(doc => { const data = doc.data(); return { id: doc.id, title: data.clientName || data.name || 'Customer', text: data.description || data.text || '', rating: data.rating || 5, date: data.date, images: data.images || (data.image ? [data.image] : []) }; }); setReviews(reviewList); } catch (error) { console.error("Error", error); } finally { setLoading(false); } };
    useEffect(() => { fetchData(); }, []);

    // REFRESH HANDLER
    const handleRefresh = async () => {
        await fetchData(); // Reload products & reviews
        if (user) await fetchUserData(user); // Reload user profile
        await new Promise(resolve => setTimeout(resolve, 1500)); // Small delay for UX
    };

    // --- RAMADAN & EIDI EFFECTS ---
    useEffect(() => {
        // Show Ramadan Modal once per session
        const hasSeenRamadan = sessionStorage.getItem('seen_ramadan_modal');
        if (!hasSeenRamadan) {
            setTimeout(() => setShowRamadanModal(true), 1500);
        }
        // Check if Eidi is claimed
        // We don't auto-show Eidi modal, user clicks a button to claim it (Gamification)
    }, []);

    // --- RECENTLY VIEWED LOAD ---
    useEffect(() => {
        const savedRecent = localStorage.getItem('ethniqRecentlyViewed');
        if (savedRecent) setRecentlyViewed(JSON.parse(savedRecent));
    }, []);

    // --- BROWSER HISTORY SUPPORT ---
    useEffect(() => {
        const onPopState = (event) => {
            if (event.state) {
                const { view: newView, product, mode, category } = event.state;
                if (mode) setAppMode(mode);
                if (category) setSelectedCategory(category);
                if (product) setSelectedProduct(product);
                if (newView) setView(newView);
            } else {
                setView('home');
                setAppMode('regular');
            }
        };
        window.addEventListener('popstate', onPopState);
        if (!window.history.state) window.history.replaceState({ view: 'home', mode: 'regular' }, '', '');
        return () => window.removeEventListener('popstate', onPopState);
    }, []);

    const handleSubmitReview = async (reviewData, onSuccess) => { try { const imageUrls = []; const storageRef = firebase.storage().ref(); if (reviewData.imageFiles && reviewData.imageFiles.length > 0) { for (const file of reviewData.imageFiles) { const fileRef = storageRef.child(`review_images/${Date.now()}_${file.name}`); await fileRef.put(file); const url = await fileRef.getDownloadURL(); imageUrls.push(url); } } const newReview = { clientName: reviewData.name, description: reviewData.text, rating: reviewData.rating, date: new Date().toISOString(), images: imageUrls }; await db.collection('artifacts').doc(APP_ID).collection('users').doc(MERCHANT_ID).collection('reviews').add(newReview); setShowSuccessModal({ show: true, title: "Review Submitted", msg: "Thanks for your feedback!" }); fetchData(); if (onSuccess) onSuccess(); } catch (error) { alert("Failed to submit review."); } };

    const addToCart = (product) => { setCart(prev => { const idx = prev.findIndex(p => p.id === product.id && p.selectedSize === product.selectedSize); if(idx > -1) { const newCart = [...prev]; newCart[idx].quantity += 1; return newCart; } return [...prev, { ...product, quantity: 1 }]; }); showNotification("Added to Bag"); };
    const updateCartQty = (index, change) => { setCart(prev => { const newCart = [...prev]; newCart[index].quantity += change; if(newCart[index].quantity < 1) newCart.splice(index, 1); return newCart; }); };
    const removeFromCart = (idx) => setCart(prev => prev.filter((_, i) => i !== idx));
    const toggleWishlist = (product) => { setWishlist(prev => { const exists = prev.find(p => p.id === product.id); if(exists) { showNotification("Removed from Wishlist"); return prev.filter(p => p.id !== product.id); } showNotification("Saved to Wishlist"); return [...prev, product]; }); };
    const removeFromWishlist = (id) => setWishlist(prev => prev.filter(p => p.id !== id));

    const handleBuyNow = (product) => {
        addToCart(product);
        setView('cart');
    };

    const handleProceedCheckout = (data) => {
        if (cart.length === 0) {
            showNotification("Your cart is empty. Please add items before proceeding.");
            return;
        }
        if (!user) {
            setIsAuthModalOpen(true);
            return;
        }
        setCheckoutData(data);
        setIsCheckoutOpen(true);
    };

    const handleConfirmOrder = async (userDetails) => {
        try {
            const addressDetails = userDetails.selectedAddress;
            const orderData = {
                userId: user.uid,
                customerName: userDetails.name,
                customerEmail: user.email,
                customerPhone: userDetails.phone,

                // Address fields saved for admin panel
                addressLine1: addressDetails.addressLine1,
                addressLine2: addressDetails.addressLine2,
                landmark: addressDetails.landmark,
                city: addressDetails.city,
                state: addressDetails.state,
                pincode: addressDetails.pincode,

                paymentMethod: userDetails.paymentMethod,
                items: cart,
                totalAmount: checkoutData.total,
                discount: checkoutData.discount,
                promoCode: checkoutData.promoCode,
                isGiftWrapped: checkoutData.isGiftWrapped || false,
                giftMessage: checkoutData.giftMessage || '',
                status: 'Pending',
                utr: userDetails.utr || '',
                createdAt: new Date().toISOString()
            };
            await db.collection('artifacts').doc(APP_ID).collection('users').doc(MERCHANT_ID).collection('orders').add(orderData);

            // Mark promo code as used
            if (checkoutData.promoCode) {
                if (user) {
                    const updates = {};
                    if (userData.zaraReward && userData.zaraReward.code === checkoutData.promoCode) updates['zaraReward.used'] = true;
                    if (userData.eidiReward && userData.eidiReward.code === checkoutData.promoCode) updates['eidiReward.used'] = true;

                    if (Object.keys(updates).length > 0) {
                        await userDocRef(user.uid).update(updates);
                        setUserData(prev => {
                            const newState = { ...prev };
                            if (updates['zaraReward.used']) newState.zaraReward = { ...newState.zaraReward, used: true };
                            if (updates['eidiReward.used']) newState.eidiReward = { ...newState.eidiReward, used: true };
                            return newState;
                        });
                    }
                }

                // FIX: Always update LocalStorage for Eidi to ensure UI updates immediately
                const localEidi = localStorage.getItem('ethniq_eidi_reward');
                if (localEidi) {
                    try {
                        const parsed = JSON.parse(localEidi);
                        if (parsed.code === checkoutData.promoCode) {
                            localStorage.setItem('ethniq_eidi_reward', JSON.stringify({ ...parsed, used: true }));
                        }
                    } catch(e) {}
                }
            }

            setCart([]);
            setIsCheckoutOpen(false);
            setShowSuccessModal({ show: true, title: "Order Placed!", msg: `Thank you ${userDetails.name}. Your order has been received.` });
        } catch (e) { alert("Order failed: " + e.message); }
    };

    const handleCancelOrder = (orderId) => {
        setConfirmation({
            isOpen: true,
            title: "Cancel Order",
            message: "Are you sure you want to cancel this order?",
            confirmText: "Yes, Cancel",
            onConfirm: async () => {
                try {
                    const orderRef = db.collection('artifacts').doc(APP_ID).collection('users').doc(MERCHANT_ID).collection('orders').doc(orderId);
                    const orderDoc = await orderRef.get();
                    const orderData = orderDoc.data();
                    await orderRef.update({ status: 'Cancelled' });

                    // Restore promo code if order is cancelled
                    if (orderData.promoCode) {
                        if (user) {
                            const updates = {};
                            if (userData.zaraReward && userData.zaraReward.code === orderData.promoCode) updates['zaraReward.used'] = false;
                            if (userData.eidiReward && userData.eidiReward.code === orderData.promoCode) updates['eidiReward.used'] = false;

                            if (Object.keys(updates).length > 0) {
                                await userDocRef(user.uid).update(updates);
                                setUserData(prev => {
                                    const newState = { ...prev };
                                    if (updates['zaraReward.used'] !== undefined) newState.zaraReward = { ...newState.zaraReward, used: false };
                                    if (updates['eidiReward.used'] !== undefined) newState.eidiReward = { ...newState.eidiReward, used: false };
                                    return newState;
                                });
                            }
                        }

                        // FIX: Restore in LocalStorage
                        const localEidi = localStorage.getItem('ethniq_eidi_reward');
                        if (localEidi) {
                            try {
                                const parsed = JSON.parse(localEidi);
                                if (parsed.code === orderData.promoCode) {
                                    localStorage.setItem('ethniq_eidi_reward', JSON.stringify({ ...parsed, used: false }));
                                }
                            } catch(e) {}
                        }
                    }

                    showNotification("Order Cancelled Successfully");
                    if (selectedOrder && selectedOrder.id === orderId) {
                        setSelectedOrder({ ...selectedOrder, status: 'Cancelled' });
                    }
                    setOrdersRefreshKey(prev => prev + 1);
                } catch (e) {
                    console.error("Error cancelling order", e);
                    showNotification("Failed to cancel order");
                }
                setConfirmation({ isOpen: false, onConfirm: () => {} });
            }
        });
    };

    const openLegal = (type) => {
        let title = '';
        let content = '';
        if (type === 'shipping') {
            title = 'Shipping Policy';
            content = "1. Domestic Shipping (India)\nWe are proud to offer Free Standard Shipping on all orders placed within India.\n\nProcessing Time: Orders are typically processed within 2â€“3 business days.\n\nDelivery Timeline: Once shipped, please allow 5â€“7 business days for your attire to reach you.\n\nTracking: You will receive a tracking link via email/SMS as soon as your order leaves our facility.\n\n2. International Shipping (Worldwide)\nEthniq Attire ships to over 50+ countries, including the USA, UK, UAE, Canada, and Australia.\n\nShipping Rates: International shipping costs are calculated at checkout based on the destination and the weight of the parcel.\n\nDelivery Timeline: International orders typically arrive within 10â€“15 business days, depending on customs clearance in your country.\n\nCustoms & Duties: Please note that any import duties, taxes, or local government charges are the responsibility of the customer. These are not included in our shipping fee.\n\n3. Order Tracking\nAs soon as your order is dispatched, we will provide you with a tracking number and a link to the courierâ€™s website so you can follow your package's journey to your doorstep.\n\n4. Delivery Partners\nTo ensure your ethnic wear arrives in perfect condition, we partner with reliable carriers such as DHL, FedEx, BlueDart, and Delhivery.\n\n5. Address Changes\nWe cannot change the shipping address once an order has been dispatched. Please double-check your international shipping address (especially ZIP/Postal codes) before finalizing your purchase.";
        } else if (type === 'returns') {
            title = 'Returns & Exchange';
            content = `At Ethniq Attire, we take great pride in the quality and craftsmanship of our ethnic wear. To maintain high hygiene standards and ensure that every customer receives a brand-new, unworn masterpiece, we follow a Replacement Only policy.\n\n1. No Returns or Refunds\nFinal Sale: All purchases made on our website are considered final sale.\n\nHygiene & Usage: Due to the nature of occasion wear, we do not offer returns or refunds. This prevents the practice of "wardrobing" (wearing an item for an event and then returning it), ensuring you always receive a fresh product.\n\n2. 7-Day Replacement for Defective Items\nIf you receive a product that is damaged or defective, we will happily provide a free replacement of the same item.\n\nTimeline: You must report the defect within 7 days of delivery.\n\nCondition: The item must be unused, unwashed, and have all original tags and packaging intact.\n\n3. Compulsory Package Opening Video\nTo be eligible for a replacement, a 360-degree uncut unboxing video is strictly mandatory.\n\nRequirement: The video must start from the moment you begin opening the outer courier seal and show the address label clearly.\n\nVerification: The video must clearly show the defect or damage in one continuous, unedited shot.\n\nNote: Without a complete opening video, we will be unable to process any claims for damage or missing items.\n\n4. How to Request a Replacement\nSend an email to ${EMAIL_ID} or WhatsApp us at ${PHONE_NUMBER}.\n\nInclude your Order Number and attach the Unboxing Video.\n\nOur team will review the footage within 48 hours and, if approved, will initiate the replacement process.`;
        } else if (type === 'terms') {
            title = 'Terms of Service';
            content = `1. Agreement to Terms\nBy accessing or purchasing from Ethniq Attire, you agree to be bound by these Terms of Service and all applicable laws and regulations. If you do not agree, you are prohibited from using this site.\n\n2. Intellectual Property Rights\nAll content on this websiteâ€”including images, logos, product descriptions, and designsâ€”is the exclusive property of Ethniq Attire and is protected by Indian and international copyright laws. You may not reproduce, "scrape," or use our photos for commercial purposes without express written consent.\n\n3. Accuracy of Information\nProduct Variations: We strive for color accuracy, but because different screens display colors differently, the actual product color may vary slightly from the images.\n\nPricing: We reserve the right to correct any pricing errors or cancel orders if an item was listed at an incorrect price due to technical issues.\n\n4. Payment & International Orders\nCurrency: All international prices are displayed in USD/GBP/EUR (as applicable).\n\nCustoms & Duties: For international orders, customers are the "importer of record" and are responsible for all local import duties, taxes, and customs clearance fees.\n\nPayment Security: We use secure, encrypted third-party payment gateways. Ethniq Attire does not store your full credit card information.\n\n5. Prohibited Uses\nYou agree not to use our website for any unlawful purpose, to transmit malware, or to harass other users. Any fraudulent activity (such as using stolen credit cards) will result in immediate order cancellation and may be reported to the authorities.\n\n6. Limitation of Liability\nEthniq Attire shall not be liable for any indirect, incidental, or consequential damages arising from the use of our products or website. Our maximum liability is limited to the total amount paid for the product in question.\n\n7. Governing Law\nThese terms are governed by and construed in accordance with the laws of India, and you irrevocably submit to the exclusive jurisdiction of the courts in Kolkata, West Bengal.`;
        }
        setLegalModal({ isOpen: true, title, content });
    };

    const handleEidiClaim = (rewardData) => {
        // Save with Timestamp for 30-day validity check
        const dataWithExpiry = { ...rewardData, timestamp: Date.now() };
        localStorage.setItem('ethniq_eidi_reward', JSON.stringify(dataWithExpiry));

        if (user) {
            userDocRef(user.uid).set({ eidiReward: dataWithExpiry }, { merge: true })
              .then(() => setUserData(prev => ({ ...prev, eidiReward: dataWithExpiry })));
        }

        showNotification(`You won ${rewardData.discountPercent}% Off! Code saved.`);
    };

    // --- COMPONENTS MOVED INSIDE APP ---

  const OrderDetailsModal = ({ order, isOpen, onClose, isPrive, onOpenProduct, onCancelOrder }) => {
      if (!isOpen || !order) return null;

      const textMainClass = isPrive ? 'text-white' : 'text-gray-900';
      const labelClass = `block text-xs font-bold uppercase tracking-wider ${isPrive ? 'text-gold-500' : 'text-gray-500'}`;
      const valueClass = `text-sm ${textMainClass}`;

      return (
          <div className="fixed inset-0 z-[80] overflow-y-auto">
              <div className="flex items-center justify-center min-h-screen p-4">
                  <div className="fixed inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose}></div>
                  <div className={`relative w-full max-w-2xl p-6 rounded-xl shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar ${isPrive ? 'bg-navy-950 text-white border border-gold-600/30' : 'bg-white text-gray-900'}`}>
                      <button onClick={onClose} className={`absolute top-4 right-4 p-2 rounded-full ${isPrive ? 'text-white hover:bg-navy-800' : 'text-gray-600 hover:bg-gray-100'} z-50`}><IconClose /></button>
                      <h3 className={`text-xl font-serif font-bold mb-4 border-b pb-2 ${isPrive ? 'border-navy-800' : 'border-gray-200'}`}>Order Details</h3>

                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center">
                          <div><p className={labelClass}>Order ID</p><p className={valueClass}>#{order.id.slice(0, 8).toUpperCase()}</p></div>
                          <div><p className={labelClass}>Date</p><p className={valueClass}>{new Date(order.createdAt).toLocaleDateString()}</p></div>
                          <div><p className={labelClass}>Total</p><p className={valueClass}>{formatCurrency(order.totalAmount)}</p></div>
                          <div><p className={labelClass}>Status</p><span className={`px-2 py-1 rounded text-[10px] font-bold uppercase ${order.status === 'Delivered' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>{order.status || 'Processing'}</span></div>
                      </div>

                      <div className="space-y-6">
                          <div>
                              <h4 className={`font-bold mb-2 ${textMainClass}`}>Items Ordered</h4>
                              <div className={`space-y-2 border rounded p-3 ${isPrive ? 'border-navy-800 bg-navy-900' : 'border-gray-200 bg-gray-50'}`}>
                                  {order.items.map((item, i) => (
                                      <button
                                          key={i}
                                          onClick={() => onOpenProduct(item)}
                                          className="w-full flex justify-between items-center text-sm text-left p-2 -m-2 rounded-lg hover:bg-white/5"
                                      >
                                          <div className="flex items-center gap-3 overflow-hidden">
                                              <img src={item.images?.[0]} className="w-10 h-10 rounded object-cover flex-shrink-0" />
                                              <div className="overflow-hidden">
                                                  <p className={`${textMainClass} truncate`}>{item.title} (x{item.quantity})</p>
                                                  <p className={`text-xs truncate ${isPrive ? 'text-gray-400' : 'text-gray-500'}`}>
                                                      Size: {item.selectedSize || 'N/A'}
                                                  </p>
                                              </div>
                                          </div>
                                          <p className={`${textMainClass} pl-2`}>{formatCurrency(item.finalPrice * item.quantity)}</p>
                                      </button>
                                  ))}
                              </div>
                          </div>
                          <div><h4 className={`font-bold mb-2 ${textMainClass}`}>Shipping Address</h4><div className={`border rounded p-3 text-sm space-y-1 ${isPrive ? 'border-navy-800 bg-navy-900 text-gray-300' : 'border-gray-200 bg-gray-50 text-gray-600'}`}><p className="font-bold text-base">{order.customerName}</p><p>{order.addressLine1}</p>{order.addressLine2 && <p>{order.addressLine2}</p>}<p>{order.city}, {order.state} - {order.pincode}</p><p>Phone: {order.customerPhone}</p></div></div>
                          <div><h4 className={`font-bold mb-2 ${textMainClass}`}>Payment Details</h4><div className={`border rounded p-3 text-sm space-y-1 ${isPrive ? 'border-navy-800 bg-navy-900' : 'border-gray-200 bg-gray-50'}`}><p><span className="font-bold">Method:</span> {order.paymentMethod}</p>{order.utr && <p><span className="font-bold">UTR/Ref:</span> {order.utr}</p>}</div></div>
                          {order.isGiftWrapped && (
                              <div>
                                  <h4 className={`font-bold mb-2 ${textMainClass}`}>Gift Details</h4>
                                  <div className={`border rounded p-3 text-sm ${isPrive ? 'border-navy-800 bg-navy-900' : 'border-pink-200 bg-pink-50'}`}>
                                      <p className="font-bold text-pink-500 mb-1">ðŸŽ Gift Wrapped</p>
                                      {order.giftMessage && <p className={`italic ${isPrive ? 'text-gray-300' : 'text-gray-700'}`}>"{order.giftMessage}"</p>}
                                  </div>
                              </div>
                          )}
                          {order.status === 'Pending' && (
                              <div className="mt-6 pt-4 border-t border-dashed border-gray-200/20">
                                  <button
                                      onClick={() => onCancelOrder(order.id)}
                                      className="w-full py-3 rounded text-red-500 font-bold border border-red-500/30 hover:bg-red-500/10 transition uppercase text-xs tracking-widest"
                                  >
                                      Cancel Order
                                  </button>
                              </div>
                          )}
                      </div>
                  </div>
              </div>
          </div>
      );
  };

  const MyOrdersView = ({ appMode, user, onViewChange, onOrderSelect }) => {
      const [orders, setOrders] = useState([]);
      const [loading, setLoading] = useState(true);
      const isPrive = appMode === 'prive';
      const bgClass = isPrive ? 'bg-navy-950 text-white' : 'bg-white text-gray-900';
      const cardBgClass = isPrive ? 'bg-navy-800 border-navy-700' : 'bg-white border-gray-100';

      useEffect(() => {
          if(!user) return;
          const fetchOrders = async () => {
              try {
                  const ordersRef = db.collection('artifacts').doc(APP_ID).collection('users').doc(MERCHANT_ID).collection('orders');
                  const snapshot = await ordersRef.where('userId', '==', user.uid).get();
                  // Sorting client-side to avoid composite index issues
                  const loadedOrders = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                  loadedOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                  setOrders(loadedOrders);
              } catch (e) { console.error("Error fetching orders", e); } finally { setLoading(false); }
          };
          fetchOrders();
      }, [user]);

      if (!user) return <div className={`min-h-screen flex items-center justify-center ${bgClass}`}>Please log in to view orders.</div>;

      return ( <div className={`min-h-screen ${bgClass} pb-20`}> <div className="max-w-4xl mx-auto px-4 py-8"> <h1 className="text-2xl font-serif font-bold mb-6">My Orders</h1> {loading ? <div className="text-center py-10">Loading...</div> : orders.length === 0 ? ( <div className="text-center py-12 opacity-60"> <IconBox className="w-16 h-16 mx-auto mb-4"/> <p>No orders yet.</p> <button onClick={() => onViewChange('home')} className="mt-4 text-gold-600 font-bold underline">Start Shopping</button> </div> ) : ( <div className="space-y-4"> {orders.map(order => ( <button key={order.id} onClick={() => onOrderSelect(order)} className={`w-full text-left p-4 rounded-lg border shadow-sm transition-all hover:shadow-md hover:border-gold-600/50 ${cardBgClass}`}> <div className="flex justify-between items-start mb-2"> <div> <p className="font-bold text-sm">Order #{order.id.slice(0,8).toUpperCase()}</p> <p className="text-xs opacity-60">{new Date(order.createdAt).toLocaleDateString()}</p> </div> <span className={`px-2 py-1 rounded text-[10px] font-bold uppercase ${order.status === 'Delivered' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}> {order.status || 'Processing'} </span> </div> <div className="space-y-1 mb-3"> {order.items.map((item, i) => ( <div key={i} className="text-sm flex justify-between"> <span className="opacity-80">{item.title} x {item.quantity}</span> <span>{formatCurrency(item.finalPrice)}</span> </div> ))} </div> <div className="border-t pt-2 flex justify-between items-center text-sm font-bold"> <span>Total</span> <span>{formatCurrency(order.totalAmount)}</span> </div> </button> ))} </div> )} </div> </div> );
  };

// NEW AuthModal component with Forgot Password feature:
Â  Â  Â  const AuthModal = ({ isOpen, onClose, isPrive, onLoginSuccess }) => {
Â  Â  Â  Â  Â  Â  const [isRegister, setIsRegister] = useState(false);
Â  Â  Â  Â  Â  Â  const [isForgot, setIsForgot] = useState(false);
Â  Â  Â  Â  Â  Â  const [email, setEmail] = useState('');
Â  Â  Â  Â  Â  Â  const [password, setPassword] = useState('');
Â  Â  Â  Â  Â  Â  const [phone, setPhone] = useState({ code: '+91', number: '' });
Â  Â  Â  Â  Â  Â  const [error, setError] = useState('');
Â  Â  Â  Â  Â  Â  const [loading, setLoading] = useState(false);
Â  Â  Â  Â  Â  Â  const [resetSuccess, setResetSuccess] = useState('');

Â  Â  Â  Â  Â  Â  if (!isOpen) return null;

Â  Â  Â  Â  Â  Â  const handleAuth = async (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  setError('');
Â  Â  Â  Â  Â  Â  Â  Â  setResetSuccess('');
Â  Â  Â  Â  Â  Â  Â  Â  setLoading(true);
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isRegister) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                          // Save phone number during registration
                          if (userCredential.user && phone.number) {
                              await userDocRef(userCredential.user.uid).set({ phoneNumber: `${phone.code}${phone.number}` }, { merge: true });
                          }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await auth.signInWithEmailAndPassword(email, password);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onLoginSuccess();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onClose();
Â  Â  Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setError(err.message);
Â  Â  Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setLoading(false);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

          const handlePasswordReset = async (e) => {
              e.preventDefault();
              setError('');
              setResetSuccess('');
              setLoading(true);
              try {
                  if (!email) {
                      setError('Please enter your email address.');
                      return;
                  }
                  await auth.sendPasswordResetEmail(email);
                  setResetSuccess('Password reset link sent! Check your email (and spam folder).');
                  setEmail(''); // Clear email after success
                  setIsForgot(false); // Go back to login screen so user can see success message
              } catch (err) {
                  setError(err.message);
              } finally {
                  setLoading(false);
              }
          };

Â  Â  Â  Â  Â  Â  const inputClass = `w-full p-3 rounded border outline-none ${isPrive ? 'bg-navy-800 border-navy-700 focus:border-gold-500' : 'bg-gray-50 border-gray-200 focus:border-gray-400'}`;
Â  Â  Â  Â  Â  Â  return (
              <div className="fixed inset-0 z-[70] flex items-center justify-center p-4">
                  <div className="fixed inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose}></div>
                  <div className={`relative w-full max-w-md p-8 rounded-xl shadow-2xl ${isPrive ? 'bg-navy-900 text-white border border-gold-600/30' : 'bg-white text-gray-900'}`}>

                      {/* HEADER TEXT */}
                      <h3 className="text-2xl font-serif font-bold mb-6 text-center">
                          {isForgot ? 'Reset Password' : (isRegister ? 'Create Account' : 'Welcome Back')}
                      </h3>

                      {/* ERROR & SUCCESS MESSAGES */}
                      {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 text-sm">{error}</div>}
                      {resetSuccess && <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4 text-sm">{resetSuccess}</div>}

                      {/* --- LOGIN/REGISTER FORM --- */}
                      {!isForgot ? (
                          <form onSubmit={handleAuth} className="space-y-4">
                              {isRegister && (
                                  <div>
                                      <label className="block text-xs font-bold uppercase tracking-wider mb-1">Phone Number</label>
                                      <div className="flex">
                                          <select value={phone.code} onChange={e => setPhone(p => ({...p, code: e.target.value}))} className={`${inputClass} rounded-r-none w-28 appearance-none`}>
                                              {countries.map(c => <option key={c.code} value={c.dial_code}>{c.dial_code}</option>)}
                                          </select>
                                          <input type="tel" value={phone.number} onChange={e => setPhone(p => ({...p, number: e.target.value.replace(/\D/g, '')}))}
                                              className={`${inputClass} rounded-l-none`} placeholder="Phone number"
                                          />
                                      </div>
                                  </div>
                              )}
                              <div>
                                  <label className="block text-xs font-bold uppercase tracking-wider mb-1">Email</label>
                                  <input type="email" required value={email} onChange={e => setEmail(e.target.value)} className={inputClass} placeholder="you@example.com" />
                              </div>
                              <div>
                                  <label className="block text-xs font-bold uppercase tracking-wider mb-1">Password</label>
                                  <input type="password" required value={password} onChange={e => setPassword(e.target.value)} className={inputClass} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
                              </div>

                              {/* FORGOT PASSWORD LINK */}
                              {!isRegister && (
                                  <div className="text-right">
                                      <button
                                          type="button"
                                          onClick={() => { setIsForgot(true); setError(''); setResetSuccess(''); }}
                                          className={`text-xs font-bold underline transition ${isPrive ? 'text-gold-500' : 'text-gray-600'}`}
                                      >
                                          Forgot Password?
                                      </button>
                                  </div>
                              )}

                              <button type="submit" disabled={loading} className={`w-full py-3 font-bold rounded uppercase tracking-wider text-sm mt-4 ${isPrive ? 'bg-gold-600 text-white hover:bg-gold-700' : 'bg-navy-900 text-white hover:bg-gray-800'} ${loading ? 'opacity-50' : ''}`}>
                                  {loading ? 'Please wait...' : (isRegister ? 'Register' : 'Login')}
                              </button>
                          </form>
                      ) : (
                      /* --- FORGOT PASSWORD FORM --- */
                          <form onSubmit={handlePasswordReset} className="space-y-4">
                              <p className={`text-sm mb-4 ${isPrive ? 'text-gray-300' : 'text-gray-600'}`}>Enter your email address and we'll send you a link to reset your password.</p>
                              <div>
                                  <label className="block text-xs font-bold uppercase tracking-wider mb-1">Email</label>
                                  <input type="email" required value={email} onChange={e => setEmail(e.target.value)} className={inputClass} placeholder="you@example.com" />
                              </div>
                              <button type="submit" disabled={loading} className={`w-full py-3 font-bold rounded uppercase tracking-wider text-sm mt-4 ${isPrive ? 'bg-gold-600 text-white hover:bg-gold-700' : 'bg-navy-900 text-white hover:bg-gray-800'} ${loading ? 'opacity-50' : ''}`}>
                                  {loading ? 'Sending Link...' : 'Send Reset Link'}
                              </button>
                              <div className="mt-4 text-center">
                                  <button
                                      type="button"
                                      onClick={() => { setIsForgot(false); setResetSuccess(''); setError(''); }}
                                      className={`font-bold ml-2 underline ${isPrive ? 'text-gold-500' : 'text-navy-900'}`}
                                  >
                                      Back to Login
                                  </button>
                              </div>
                          </form>
                      )}

                      {/* TOGGLE REGISTER/LOGIN LINKS (only show if not in forgot mode) */}
                      {!isForgot && (
                          <div className="mt-6 text-center text-sm">
                              <span className="opacity-70">{isRegister ? "Already have an account?" : "Don't have an account?"}</span>
                              <button onClick={() => { setIsRegister(!isRegister); setError(''); setResetSuccess(''); }} className={`font-bold ml-2 underline ${isPrive ? 'text-gold-500' : 'text-navy-900'}`}>
                                  {isRegister ? 'Login' : 'Register'}
                              </button>
                          </div>
                      )}

                      <button onClick={onClose} className="absolute top-4 right-4"><IconClose /></button>
                  </div>
              </div>
          );
Â  Â  Â  Â  };
    const CheckoutModal = ({ isOpen, onClose, onConfirmOrder, totalAmount, appMode, user, userData, cart, checkIsPrive }) => {
          const isPrive = appMode === 'prive';
          const availableAddresses = userData.addresses || [];

          // NEW: Payment method logic based on cart contents
          const cartHasPriveItem = cart.some(item => checkIsPrive(item));
          const paymentOptions = {
              'UPI': 'UPI (Fast & Free)',
              'COD': 'Cash on Delivery',
              'Bank Transfer': 'Bank Transfer',
              'QR Payment': 'QR Payment'
          };
          const availablePaymentMethods = cartHasPriveItem
              ? ['UPI', 'QR Payment', 'Bank Transfer']
              : ['UPI', 'QR Payment', 'Bank Transfer', 'COD'];

          // Safer initialization for default address
          const defaultAddress = availableAddresses[0] || {
              addressLine1: '', addressLine2: '', landmark: '', city: '', state: '', pincode: ''
          };

          const initialForm = {
              name: userData.name || user?.displayName || '', // phone is handled by parsePhoneNumber
              paymentMethod: availablePaymentMethods[0], // Default to the first available method
              selectedAddressIndex: availableAddresses.length > 0 ? 0 : -1, // -1 means manual entry/fallback to manualAddress
          };

          const [formData, setFormData] = useState(initialForm);
          const [error, setError] = useState('');
          const [utr, setUtr] = useState('');

          // NEW: Handler for UTR input to only allow 12-digit numbers
          const handleUtrChange = (e) => {
              const value = e.target.value.replace(/\D/g, ''); // Remove non-digits
              if (value.length <= 12) {
                  setUtr(value);
              }
          };

          // State for manually entering/editing address fields (initialized with first saved address or empty fields)
          const [manualAddress, setManualAddress] = useState(defaultAddress);

          const [phone, setPhone] = useState({ code: '+91', number: '' });

          useEffect(() => {
               setFormData(initialForm);
               setManualAddress(defaultAddress);
               const { countryCode: initialCountryCode, number: initialPhoneNumber } = parsePhoneNumber(userData.phoneNumber || user?.phoneNumber);
               setPhone({ code: initialCountryCode, number: initialPhoneNumber });
          }, [isOpen, user, userData, appMode]);

          const copyToClipboard = (text, fieldName) => {
              navigator.clipboard.writeText(text).then(() => {
                  showNotification(`${fieldName} copied!`);
              }, (err) => {
                  console.error('Could not copy text: ', err);
              });
          };
          // Determine the final address object based on selection
          const finalAddress = formData.selectedAddressIndex > -1
              ? availableAddresses[formData.selectedAddressIndex]
              : manualAddress;

          const handleManualAddressChange = (e) => {
              const { name, value } = e.target;
              setManualAddress(prev => ({ ...prev, [name]: value }));
              setFormData(prev => ({ ...prev, selectedAddressIndex: -1 }));
          }

          const handlePincodeChange = (e) => {
              const value = e.target.value.replace(/\D/g, '');
              if (value.length <= 6) {
                  setManualAddress(prev => ({ ...prev, pincode: value }));
                  setFormData(prev => ({ ...prev, selectedAddressIndex: -1 }));
              }
          };

          const handleSubmit = (e) => {
              e.preventDefault();
              setError('');

              if (!phone.number.trim()) { setError("Phone number is required."); return; }

              // Address Validation
              if(!formData.name.trim() || !finalAddress.addressLine1?.trim() || !finalAddress.city?.trim() || !finalAddress.state?.trim() || !finalAddress.pincode?.trim()) {
                  setError("Full Name and a complete shipping address (Line 1, City, State, Pincode) are compulsory.");
                  return;
              }
              if(finalAddress.pincode.length !== 6) { setError("Pincode must be 6 digits."); return; }

              // Payment Validation
              if(['UPI', 'QR Payment', 'Bank Transfer'].includes(formData.paymentMethod)) { if(!utr.trim()) { setError("Please enter UTR/Reference No after paying."); return; } if(utr.length !== 12) { setError("UTR must be exactly 12 digits."); return; } }

              // Prepare final submission data
              const submissionData = {
                  name: formData.name,
                  phone: `${phone.code}${phone.number}`,
                  paymentMethod: formData.paymentMethod,
                  utr: utr,
                  selectedAddress: finalAddress, // Pass all address fields for admin panel
              };

              onConfirmOrder(submissionData);
          };

          // NEW: WhatsApp Order Handler for customers who prefer manual ordering
          const handleWhatsAppOrder = () => {
              let msg = `*New Order Request* ðŸ›ï¸\n\n`;
              msg += `*Customer:* ${formData.name || 'Guest'}\n`;
              if(phone.number) msg += `*Phone:* ${phone.code}${phone.number}\n`;

              // Address if available
              if (finalAddress.addressLine1) {
                  msg += `*Address:* ${finalAddress.addressLine1}, ${finalAddress.city}, ${finalAddress.pincode}\n`;
              }

              msg += `\n*Items:*\n`;
              cart.forEach((item, i) => {
                  msg += `${i+1}. ${item.title} (Size: ${item.selectedSize || 'N/A'}) - ${formatCurrency(item.finalPrice)}\n`;
              });

              msg += `\n*Total Amount:* ${formatCurrency(totalAmount)}\n`;
              msg += `\n----------------------------\n`;
              msg += `I want to place this order via WhatsApp. Please confirm availability and payment details.`;

              const encodedMsg = encodeURIComponent(msg);
              window.open(`https://wa.me/${PHONE_NUMBER.replace(/\D/g, '')}?text=${encodedMsg}`, '_blank');
          };

          // UPI Link Generator
          const upiLink = useMemo(() => {
              const formattedAmount = Number(totalAmount).toFixed(2); // Ensure amount has max 2 decimal places
              return `upi://pay?pa=${UPI_ID}&pn=${encodeURIComponent(MERCHANT_NAME)}&am=${formattedAmount}&cu=INR`;
          }, [totalAmount]);

          // *** GUARD CLAUSE FIX ***
          if (!isOpen || !user) return null;

          return ( <div className="fixed inset-0 z-[70] flex items-center justify-center p-4"> <div className="fixed inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div> <div className="bg-white rounded-xl w-full max-w-md relative z-10 overflow-hidden shadow-2xl max-h-[90vh] overflow-y-auto"> <div className="bg-navy-900 p-4 text-white text-center font-bold text-lg">Checkout â€¢ {formatCurrency(totalAmount)}</div> <form onSubmit={handleSubmit} className="p-6 space-y-4"> {error && <div className="text-red-500 text-xs font-bold text-center">{error}</div>}

              <h3 className="text-sm font-bold text-gray-700 uppercase">Contact Details *</h3>
              <div><label className="text-xs font-bold text-gray-500 uppercase">Full Name *</label><input type="text" required className="w-full p-3 border rounded" name="name" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} /></div>
              <div>
                  <label className="text-xs font-bold text-gray-500 uppercase">Phone Number *</label>
                  <div className="flex">
                      <select value={phone.code} onChange={e => setPhone(p => ({...p, code: e.target.value}))} className="w-28 p-3 border rounded-l bg-gray-50 appearance-none">
                          {countries.map(c => <option key={c.code} value={c.dial_code}>{c.code} ({c.dial_code})</option>)}
                      </select>
                      <input type="tel" required className="flex-1 p-3 border rounded-r outline-none"
                          name="phone" value={phone.number}
                          onChange={e => setPhone(p => ({...p, number: e.target.value.replace(/\D/g, '')}))}
                          placeholder="Enter phone number" />
                  </div>
              </div>

              <h3 className="text-sm font-bold text-gray-700 uppercase pt-4">Shipping Address *</h3>

              {/* ADDRESS SELECTION TABS */}
              {availableAddresses.length > 0 && (
                  <div className="border p-3 rounded">
                      <label className="text-xs font-bold text-gray-500 uppercase mb-2 block">Select Saved Address ({availableAddresses.length} saved)</label>
                      <div className="flex flex-wrap gap-2">
                          {availableAddresses.map((addr, index) => (
                              <button
                                  type="button"
                                  key={index}
                                  onClick={() => setFormData(prev => ({ ...prev, selectedAddressIndex: index }))}
                                  className={`px-4 py-2 border rounded-full text-xs font-bold transition-colors whitespace-nowrap ${formData.selectedAddressIndex === index ? 'bg-navy-900 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                              >
                                  Address {index + 1}
                              </button>
                          ))}
                          {/* Option to enter a new address manually */}
                          <button
                              type="button"
                              onClick={() => setFormData(prev => ({ ...prev, selectedAddressIndex: -1 }))}
                              className={`px-4 py-2 border rounded-full text-xs font-bold transition-colors whitespace-nowrap ${formData.selectedAddressIndex === -1 ? 'bg-gold-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                          >
                              Enter Manually
                          </button>
                      </div>
                  </div>
              )}

              {/* ADDRESS INPUT/DISPLAY FIELDS (Uses finalAddress for values) */}
              <div className="p-4 border rounded space-y-3 bg-gray-50">
                  <p className="text-xs font-bold text-gray-600 uppercase mb-2">
                      {availableAddresses.length === 0 ? 'Enter Address Details' : (formData.selectedAddressIndex > -1 ? `Using Saved Address ${formData.selectedAddressIndex + 1}` : 'Manual Address Details')}
                  </p>

                  {[
                      { label: 'Address Line 1*', name: 'addressLine1', required: true },
                      { label: 'Address Line 2', name: 'addressLine2', required: false },
                      { label: 'Landmark', name: 'landmark', required: false },
                      { label: 'City*', name: 'city', required: true },
                      { label: 'State*', name: 'state', required: true },
                      { label: 'Pincode* (Numeric)', name: 'pincode', required: true, type: 'tel', maxLength: 6 },
                  ].map((field) => {
                      const targetValue = finalAddress[field.name];
                      const isReadOnly = formData.selectedAddressIndex > -1 && availableAddresses.length > 0;

                      return (
                          <div key={field.name}>
                              <label className="text-xs font-bold text-gray-500 uppercase">{field.label}</label>
                              {isReadOnly ? (
                                  <div className="w-full p-3 bg-white border border-dashed rounded text-gray-800 text-sm">
                                      {targetValue || 'N/A'}
                                  </div>
                              ) : (
                                  <input
                                      type={field.type || 'text'}
                                      required={field.required}
                                      className="w-full p-3 border rounded"
                                      name={field.name}
                                      value={targetValue || ''}
                                      maxLength={field.maxLength}
                                      onChange={e => field.name === 'pincode' ? handlePincodeChange(e) : handleManualAddressChange(e)}
                                  />
                              )}
                          </div>
                      );
                  })}
              </div>


              <h3 className="text-sm font-bold text-gray-700 uppercase pt-4">Payment Method *</h3>
              <div>
                  <select
                      className="w-full p-3 border rounded bg-white"
                      value={formData.paymentMethod}
                      onChange={e => setFormData(prev => ({...prev, paymentMethod: e.target.value}))}
                  >
                      {availablePaymentMethods.map(method => (
                          <option
                              key={method}
                              value={method}
                          >
                              {paymentOptions[method]}
                          </option>
                      ))}
                  </select>
                  {cartHasPriveItem && (
                      <p className="text-red-500 text-xs mt-1 font-bold">Cash on Delivery is not available for PrivÃ© orders. UPI or Bank Transfer required.</p>
                  )}
                  {formData.paymentMethod === 'COD' && (
                      <p className="text-red-600 text-xs mt-1 font-bold">COD is not available at your location.</p>
                  )}
              </div>

              {/* UPI PAYMENT SECTION */}
              {formData.paymentMethod === 'UPI' && (
                  <div className="bg-blue-50 p-4 rounded border border-blue-200 text-center">
                      <p className="text-sm font-bold text-navy-900 mb-2">Pay {formatCurrency(totalAmount)}</p>
                      <a href={upiLink} target="_blank" className="block w-full bg-blue-600 text-white py-2 rounded font-bold mb-3 hover:bg-blue-700">PAY VIA UPI APP</a>
                      <p className="text-xs text-gray-500 mb-2">After payment, enter the 12-digit UTR/Ref No below:</p>
                      <input type="tel" placeholder="Enter 12-digit UTR" maxLength="12" className="w-full p-2 border rounded text-center" value={utr} onChange={handleUtrChange} />
                  </div>
              )}

              {/* BANK TRANSFER SECTION */}
              {formData.paymentMethod === 'Bank Transfer' && (
                  <div className="bg-gray-50 p-4 rounded border border-gray-200 space-y-3">
                      <p className="text-sm font-bold text-navy-900 text-center">Pay {formatCurrency(totalAmount)} to this account:</p>
                      <div className="text-sm">
                          <div className="flex justify-between items-center"> <span className="font-bold text-gray-600">Account No:</span> <span className="font-mono">{BANK_ACCOUNT_NUMBER}</span> <button type="button" onClick={() => copyToClipboard(BANK_ACCOUNT_NUMBER, 'Account No')} className="text-xs underline ml-2">Copy</button> </div>
                          <div className="flex justify-between items-center"> <span className="font-bold text-gray-600">IFSC Code:</span> <span className="font-mono">{BANK_IFSC_CODE}</span> <button type="button" onClick={() => copyToClipboard(BANK_IFSC_CODE, 'IFSC Code')} className="text-xs underline ml-2">Copy</button> </div>
                          <div className="flex justify-between items-center"> <span className="font-bold text-gray-600">Name:</span> <span>{BANK_BENEFICIARY_NAME}</span> <button type="button" onClick={() => copyToClipboard(BANK_BENEFICIARY_NAME, 'Name')} className="text-xs underline ml-2">Copy</button> </div>
                      </div>
                      <div className="text-center pt-2">
                          <p className="text-xs text-gray-500 mb-2">After payment, enter the 12-digit UTR/Ref No below:</p>
                          <input type="tel" placeholder="Enter 12-digit UTR" maxLength="12" className="w-full p-2 border rounded text-center" value={utr} onChange={handleUtrChange} />
                      </div>
                  </div>
              )}


              {/* QR PAYMENT SECTION */}
              {formData.paymentMethod === 'QR Payment' && (
                  <div className="bg-gray-50 p-4 rounded border border-gray-200 text-center">
                      <p className="text-sm font-bold text-navy-900 mb-2">Scan to Pay {formatCurrency(totalAmount)}</p>
                      <img src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiLink)}`} alt="QR Code for Payment" className="w-40 h-40 mx-auto mb-3 rounded-lg border p-1 bg-white" />
                      <a href={upiLink} target="_blank" className="block w-full bg-blue-600 text-white py-2 rounded font-bold mb-3 hover:bg-blue-700">PAY VIA PAYMENT APP</a>
                      <p className="text-xs text-gray-500 mb-2">After payment, enter the 12-digit UTR/Ref No below:</p>
                      <input type="tel" placeholder="Enter 12-digit UTR" maxLength="12" className="w-full p-2 border rounded text-center" value={utr} onChange={handleUtrChange} />
                  </div>
              )}

              <button
                  type="submit"
                  disabled={formData.paymentMethod === 'COD'}
                  className="w-full bg-green-600 text-white py-3 rounded font-bold hover:bg-green-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
              >Confirm Order</button>

              {/* WHATSAPP ORDER BUTTON (Trust Builder) */}
              <div className="mt-4 pt-4 border-t border-dashed border-gray-300 text-center">
                  <p className="text-xs text-gray-500 mb-3 font-bold">Prefer to order manually?</p>
                  <button
                      type="button"
                      onClick={handleWhatsAppOrder}
                      className="w-full py-3 rounded font-bold border-2 border-green-500 text-green-600 hover:bg-green-50 flex items-center justify-center gap-2 transition"
                  >
                      <IconWhatsapp /> Order via WhatsApp
                  </button>
                  <p className="text-[10px] text-gray-400 mt-2">Chat directly with us to place your order.</p>
              </div>

              </form> <button onClick={onClose} className="absolute top-4 right-4 text-white"><IconClose /></button> </div> </div> );
      };

    const MobileBottomBar = ({ cartCount, wishlistCount, onViewChange, appMode, view, onSearchClick, onCategoryClick, user }) => {
          const isPrive = appMode === 'prive';
          const barClass = isPrive ? 'bg-navy-950 border-navy-800 text-gray-400' : 'bg-white border-gray-100 text-gray-600';
          const activeClass = isPrive ? 'text-gold-500' : 'text-gold-600';
          const NavItem = ({ icon: Icon, label, viewName, onClick, count }) => {
              const isActive = view === viewName;
              return ( <button onClick={onClick || (() => onViewChange(viewName))} className={`flex-1 flex flex-col items-center justify-center py-2 relative ${isActive ? activeClass : ''}`}> <Icon className="h-5 w-5" filled={isActive && viewName === 'wishlist'} /> <span className="text-[9px] font-bold uppercase tracking-widest mt-1">{label}</span> {count > 0 && <span className="absolute top-1 right-1/4 inline-flex items-center justify-center h-3.5 w-3.5 text-[8px] font-bold leading-none text-white bg-red-500 rounded-full">{count}</span>} </button> );
          };

          return ( <div className={`md:hidden fixed bottom-0 left-0 w-full z-50 border-t flex justify-between ${barClass} pb-safe`}>
              <NavItem icon={IconHome} label="Home" onClick={() => onViewChange('home')} viewName="home" />
              <NavItem icon={IconCategory} label="Category" onClick={onCategoryClick} />
              <NavItem icon={IconStarOutline} label="Reviews" viewName="reviews" />
              <NavItem icon={IconHeart} label="Wishlist" viewName="wishlist" count={wishlistCount} />
              <NavItem icon={IconBag} label="Cart" viewName="cart" count={cartCount} />
          </div> );
      };

    // --- END COMPONENTS MOVED INSIDE APP ---

    const isPrive = appMode === 'prive';
    const checkIsPrive = (p) => { if (p.collectionType) return p.collectionType === 'Prive'; const price = parseFloat(p.finalPrice || 0); const cat = (p.category || '').toLowerCase(); return price > PRIVE_PRICE_THRESHOLD || cat.includes('prive') || cat.includes('luxury'); };
    const currentStoreProducts = products.filter(p => { const productIsPrive = checkIsPrive(p); return isPrive ? productIsPrive : !productIsPrive; });
    const categories = ['All', ...new Set(currentStoreProducts.map(p => p.category).filter(Boolean))];

    // --- ADVANCED SORTING & FILTERING LOGIC ---
    const filteredProducts = useMemo(() => {
        let result = currentStoreProducts.filter(p => {
            const matchesSearch = p.title.toLowerCase().includes(searchQuery.toLowerCase());
            const matchesCategory = selectedCategory === 'All' || (p.category && p.category === selectedCategory);
            return matchesSearch && matchesCategory;
        });

        if (sortBy === 'price_low') result.sort((a, b) => a.finalPrice - b.finalPrice);
        else if (sortBy === 'price_high') result.sort((a, b) => b.finalPrice - a.finalPrice);
        // 'newest' uses default order (assuming database returns roughly in order or we can add date sort if needed)

        return result;
    }, [currentStoreProducts, searchQuery, selectedCategory, sortBy]);

    const displayedProducts = showAllProducts ? filteredProducts : filteredProducts.slice(0, INITIAL_PRODUCT_LIMIT);

    // --- DYNAMIC PAGE TITLES (SEO) ---
    useEffect(() => {
        if (view === 'product' && selectedProduct) {
            document.title = `${selectedProduct.title} | Ethniq Attire`;
        } else {
            document.title = isPrive ? "Ethniq PrivÃ© | Luxury Collection" : "Ethniq Attire | Premium & Luxury";
        }
    }, [view, selectedProduct, isPrive]);

    // --- RENDER GUARDS ---
    if (!isOnline) return <OfflinePage />;

    const scrollToCollection = () => { setTimeout(() => { const element = document.getElementById('collection'); if(element) element.scrollIntoView({ behavior: 'smooth' }); }, 100); };
    const scrollToContact = () => { setTimeout(() => { const element = document.getElementById('contact-section'); if(element) element.scrollIntoView({ behavior: 'smooth' }); }, 100); };
    const handleViewChange = (action) => {
        const switchAction = () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            let nextView = action;
            let nextMode = appMode;
            if (action === 'switch_to_prive') { nextMode = 'prive'; nextView = 'home'; setAppMode('prive'); setView('home'); setSelectedCategory('All'); setSearchQuery(''); setShowAllProducts(false); }
            else if (action === 'switch_to_regular') { nextMode = 'regular'; nextView = 'home'; setAppMode('regular'); setView('home'); setSelectedCategory('All'); setSearchQuery(''); setShowAllProducts(false); }
            else { setView(action); if(action === 'home') { setSearchQuery(''); setShowAllProducts(false); setSelectedProduct(null); } }
            window.history.pushState({ view: nextView, mode: nextMode }, '', '');
        };

        if ((action === 'switch_to_prive' || action === 'switch_to_regular') && cart.length > 0) {
            setConfirmation({ isOpen: true, onConfirm: () => { setCart([]); switchAction(); setConfirmation({isOpen: false}); } });
        } else {
            switchAction();
        }
    };
    const handleCategorySelect = (category) => { setSelectedCategory(category); setView('collection'); setIsCategoryModalOpen(false); window.history.pushState({ view: 'collection', category: category, mode: appMode }, '', ''); };

    const handleOpenProduct = (product) => {
        setSelectedProduct(product);
        setView('product');
        window.scrollTo(0,0);
        window.history.pushState({ view: 'product', product: product, mode: appMode }, '', '');

        // Add to Recently Viewed History
        setRecentlyViewed(prev => {
            // Remove duplicates and keep last 2 items
            const newHistory = [product, ...prev.filter(p => p.id !== product.id)].slice(0, 2);
            localStorage.setItem('ethniqRecentlyViewed', JSON.stringify(newHistory));
            return newHistory;
        });
    };

    return (
      <PullToRefresh onRefresh={handleRefresh}>
      <div className={`min-h-screen flex flex-col transition-colors duration-500 ${isPrive ? 'bg-navy-950' : 'bg-white'}`}>
          <AnnouncementBar isPrive={isPrive} />
          <FestiveDecorations />
          <Navbar
              cartCount={cart.reduce((a,b)=>a+b.quantity,0)}
              wishlistCount={wishlist.length}
              onViewChange={handleViewChange}
              searchQuery={searchQuery}
              setSearchQuery={setSearchQuery}
              onScrollToContact={scrollToContact}
              onScrollToCollection={scrollToCollection}
              appMode={appMode}
              filteredProducts={filteredProducts}
              onOpenProduct={handleOpenProduct}
              view={view}
              onCategoryClick={() => setIsCategoryModalOpen(true)}
              onSearchClick={() => setIsSearchModalOpen(true)}
              user={user}
              userData={userData}
              onAuthClick={() => setIsAuthModalOpen(true)}
          />
          <NotificationToast message={notification.message} isVisible={notification.show} isPrive={isPrive} />

          {view === 'home' && (
              <>
                  <HeroCarousel slides={isPrive ? PRIVE_SLIDES : REGULAR_SLIDES} isPrive={isPrive} onScrollToCollection={scrollToCollection} />
                  <div id="collection" className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 w-full">
                      <div className="text-center mb-12">
                          <h2 className={`text-4xl font-serif font-bold mb-3 ${isPrive ? 'text-gold-500 italic' : 'text-gray-900'}`}>{isPrive ? 'The Prive Collection' : 'Our Collection'}</h2>
                          <div className="w-24 h-1 bg-gold-600 mx-auto mb-6"></div>

                          {/* EIDI BUTTON */}
                          {!localStorage.getItem('ethniq_eidi_reward') && !userData?.eidiReward && (
                              <div className="mb-8 animate-bounce">
                                  <button onClick={() => setShowEidiModal(true)} className="bg-gradient-to-r from-green-600 to-emerald-800 text-white px-6 py-3 rounded-full font-bold shadow-lg border-2 border-gold-500 flex items-center gap-2 mx-auto hover:scale-105 transition">ðŸŽ Claim Your Eidi</button>
                              </div>
                          )}

                          <CategoryFilter categories={categories} selectedCategory={selectedCategory} onSelectCategory={handleCategorySelect} isPrive={isPrive} />

                          {/* SORT CONTROL UI */}
                          <div className="flex justify-center md:justify-end mb-6">
                              <select value={sortBy} onChange={(e) => setSortBy(e.target.value)} className={`text-xs font-bold uppercase tracking-wider border rounded px-4 py-2 outline-none cursor-pointer transition-colors ${isPrive ? 'bg-navy-900 text-gold-500 border-navy-800 hover:border-gold-500' : 'bg-white text-gray-700 border-gray-200 hover:border-gray-400'}`}>
                                  <option value="newest">Sort By: Newest</option>
                                  <option value="price_low">Price: Low to High</option>
                                  <option value="price_high">Price: High to Low</option>
                              </select>
                          </div>
                      </div>
                      {loading ? <div className="flex justify-center py-20"><div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-gold-600"></div></div> : filteredProducts.length === 0 ? <div className="text-center py-20 text-gray-500">No products found.</div> : (
                          <>
                              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6 lg:gap-8">
                                  {displayedProducts.map(product => (<ProductCard key={product.id} product={product} onOpen={handleOpenProduct} isPrive={isPrive} onToggleWishlist={toggleWishlist} isWishlisted={wishlist.some(w => w.id === product.id)} />))}
                              </div>
                              {!showAllProducts && filteredProducts.length > INITIAL_PRODUCT_LIMIT && (
                                  <div className="mt-12 text-center">
                                      <button onClick={() => setShowAllProducts(true)} className={`px-8 py-3 border rounded-sm uppercase tracking-widest text-xs font-bold transition-all ${isPrive ? 'border-gold-500 text-gold-500 hover:bg-gold-500 hover:text-navy-900' : 'border-navy-900 text-navy-900 hover:bg-navy-900 hover:text-white'}`}>Show All Products ({filteredProducts.length})</button>
                                  </div>
                              )}
                          </>
                      )}
                  </div>
                  {!isPrive && <div className="max-w-7xl mx-auto px-4 mb-16"><div className="bg-navy-900 rounded-2xl p-8 md:p-12 text-center text-white"><h2 className="text-3xl font-serif italic mb-4 text-gold-500">Looking for something exclusive?</h2><p className="mb-6 text-gray-300">Explore our premium range of designer wear.</p><button onClick={() => handleViewChange('switch_to_prive')} className="px-8 py-3 border border-gold-500 text-gold-500 hover:bg-gold-500 hover:text-navy-900 transition uppercase tracking-widest text-xs font-bold">Enter Ethniq PrivÃ©</button></div></div>}
                  <CharityBanner isPrive={isPrive} />
                  <BrandStory appMode={appMode} />
                  <RecentlyViewedSection products={recentlyViewed} onOpen={handleOpenProduct} isPrive={isPrive} />
                  <ReviewsSection reviews={reviews} appMode={appMode} onWriteReview={() => setIsReviewModalOpen(true)} />
                  <ContactSection instaLink={isPrive ? INSTA_LINK_PRIVE : INSTA_LINK_REGULAR} appMode={appMode} />
              </>
          )}

          {view === 'profile' && user && (
              <ProfileView
                  user={user}
                  userData={userData}
                  onSaveProfile={handleSaveProfile}
                  onLogout={handleLogout}
                  appMode={appMode}
                  onViewChange={handleViewChange}
              />
          )}

          {view === 'collection' && ( <CollectionView category={selectedCategory} products={filteredProducts} onOpenProduct={handleOpenProduct} onToggleWishlist={toggleWishlist} wishlist={wishlist} onBack={() => window.history.back()} isPrive={isPrive} /> )}
          {view === 'cart' && ( <CartView cart={cart} onUpdateQty={updateCartQty} onRemove={removeFromCart} onCheckout={handleProceedCheckout} appMode={appMode} onViewChange={handleViewChange} onOpenProduct={handleOpenProduct} user={user} userData={userData} /> )}
          {view === 'wishlist' && ( <WishlistView wishlist={wishlist} onRemove={removeFromWishlist} onAddToCart={addToCart} appMode={appMode} onViewChange={handleViewChange} onOpenProduct={handleOpenProduct} /> )}
          {view === 'orders' && <MyOrdersView key={ordersRefreshKey} appMode={appMode} user={user} onViewChange={handleViewChange} onOrderSelect={setSelectedOrder} />}
          {view === 'reviews' && <div className={`min-h-screen ${isPrive ? 'bg-navy-950' : 'bg-white'}`}><ReviewsSection reviews={reviews} appMode={appMode} onWriteReview={() => setIsReviewModalOpen(true)} /><div className="text-center pb-16"><button onClick={() => handleViewChange('home')} className="px-6 py-2 border">Back to Home</button></div></div>}

          {view === 'product' && selectedProduct && (
              <ProductDetailView
                  key={selectedProduct.id}
                  product={selectedProduct}
                  onBack={() => window.history.back()}
                  onAddToCart={addToCart}
                  onBuyNow={handleBuyNow}
                  allProducts={currentStoreProducts}
                  onOpen={handleOpenProduct}
                  isPrive={isPrive}
                  onToggleWishlist={toggleWishlist}
                  wishlist={wishlist}
              />
          )}

          <footer className={`py-12 text-center text-xs transition-colors duration-500 ${isPrive ? 'bg-navy-950 text-gray-400' : 'bg-gray-900 text-gray-400'}`}>
              <div className="flex justify-center gap-8 mb-8 font-bold uppercase tracking-widest">
                  <button onClick={() => openLegal('shipping')} className="hover:text-white transition">Shipping Policy</button>
                  <button onClick={() => openLegal('returns')} className="hover:text-white transition">Returns & Exchange</button>
                  <button onClick={() => openLegal('terms')} className="hover:text-white transition">Terms of Service</button>
              </div>
              <p className="opacity-50">&copy; 2025 Ethniq Attire Kolkata. All Rights Reserved.</p>
          </footer>

          {user && <AIChatAssistant user={user} isPrive={isPrive} products={products} userData={userData} onOpenProduct={handleOpenProduct} />}
          <FloatingWhatsApp />
          <MobileBottomBar
              cartCount={cart.reduce((a,b)=>a+b.quantity,0)}
              wishlistCount={wishlist.length}
              onViewChange={handleViewChange}
              appMode={appMode}
              view={view}
              onCategoryClick={() => setIsCategoryModalOpen(true)}
          />

          <OrderDetailsModal
              order={selectedOrder}
              isOpen={!!selectedOrder}
              onClose={() => setSelectedOrder(null)}
              isPrive={isPrive}
              onOpenProduct={(product) => { setSelectedOrder(null); handleOpenProduct(product); }}
              onCancelOrder={handleCancelOrder}
          />
          <CheckoutModal isOpen={isCheckoutOpen} onClose={() => setIsCheckoutOpen(false)} onConfirmOrder={handleConfirmOrder} totalAmount={checkoutData.total} user={user} userData={userData} appMode={appMode} cart={cart} checkIsPrive={checkIsPrive} showNotification={showNotification} />
          <AuthModal isOpen={isAuthModalOpen} onClose={() => setIsAuthModalOpen(false)} isPrive={isPrive} onLoginSuccess={() => { showNotification('Logged In Successfully'); setIsAuthModalOpen(false); if (view !== 'cart') handleViewChange('profile'); }} />

          <WriteReviewModal isOpen={isReviewModalOpen} onClose={() => setIsReviewModalOpen(false)} onSubmit={handleSubmitReview} isPrive={isPrive} />
          <SuccessModal isOpen={showSuccessModal.show} onClose={() => setShowSuccessModal({...showSuccessModal, show: false})} isPrive={isPrive} title={showSuccessModal.title} message={showSuccessModal.msg} />
          <SearchModal isOpen={isSearchModalOpen} onClose={() => setIsSearchModalOpen(false)} searchQuery={searchQuery} setSearchQuery={setSearchQuery} results={filteredProducts} onOpenProduct={handleOpenProduct} isPrive={isPrive} onSeeAll={() => { setIsSearchModalOpen(false); scrollToCollection(); }} />
          <CategoriesModal isOpen={isCategoryModalOpen} onClose={() => setIsCategoryModalOpen(false)} categories={categories} onSelectCategory={handleCategorySelect} isPrive={isPrive} />
          <ConfirmationModal
              isOpen={confirmation.isOpen}
              onClose={() => setConfirmation({ isOpen: false })}
              onConfirm={confirmation.onConfirm}
              title={confirmation.title || "Clear Your Cart?"}
              message={confirmation.message || "Switching collections will empty your current shopping cart. Do you want to continue?"}
              confirmText={confirmation.confirmText || "Yes, Switch"}
              isPrive={isPrive}
          />
          <LegalModal isOpen={legalModal.isOpen} onClose={() => setLegalModal({ ...legalModal, isOpen: false })} title={legalModal.title} content={legalModal.content} isPrive={isPrive} />

          <RamadanModal
              isOpen={showRamadanModal}
              onClose={() => { setShowRamadanModal(false); sessionStorage.setItem('seen_ramadan_modal', 'true'); }}
          />
          <EidiModal
              isOpen={showEidiModal}
              onClose={() => setShowEidiModal(false)}
              onClaim={handleEidiClaim}
          />
      </div>
      </PullToRefresh>
    );
  }

  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(<App />);
</script>
</body>
</html>